<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NE TRAVAUX - Gestion de Stock (DEBUG)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="./logo.jpg.jpg">
</head>
<body>
    <div id="root"></div>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        // Configuration Supabase
        const SUPABASE_URL = 'https://sltmmvuxcanzhqakrtrw.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsdG1tdnV4Y2FuemhxYWtydHJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDk2MDIsImV4cCI6MjA3MDIyNTYwMn0.zlue3-HiLaxu6Frg27pZokTCvW4rlkesT-1RxRyjoxU'

        console.log('🔧 Configuration Supabase:', {
            url: SUPABASE_URL,
            key: SUPABASE_ANON_KEY ? 'PRÉSENT' : 'MANQUANT'
        })

        // Créer le client Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Fonctions de base de données
        window.supabaseDB = {
            async getUsers() {
                console.log('🔍 getUsers appelé');
                const { data, error } = await supabase.from('users').select('*');
                console.log('🔍 getUsers résultat:', { data, error });
                return data || [];
            },

            async getChantiers() {
                console.log('🔍 getChantiers appelé');
                const { data, error } = await supabase.from('chantiers').select('*');
                console.log('🔍 getChantiers résultat:', { data, error });
                return data || [];
            },

            async getArticles() {
                console.log('🔍 getArticles appelé');
                const { data, error } = await supabase.from('articles').select('*');
                console.log('🔍 getArticles résultat:', { data, error });
                return data || [];
            },

            async getUserByMatricule(matricule) {
                console.log('🔍 getUserByMatricule appelé avec:', matricule);
                const { data, error } = await supabase.from('users').select('*').eq('matricule', matricule);
                console.log('🔍 getUserByMatricule résultat:', { data, error });
                return { data, error };
            }
        };

        // Données initiales VIDE
        const initialUsers = [
            { matricule: '100', nom: 'Said El Khalfaoui', role: 'admin', chantier: 'Admin' }
        ];
        const initialChantiers = [];
        const initialArticles = [];

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState(initialUsers);
            const [chantiers, setChantiers] = useState(initialChantiers);
            const [articles, setArticles] = useState(initialArticles);

            // Charger les données au démarrage
            useEffect(() => {
                const loadData = async () => {
                    try {
                        console.log('🚀 Début du chargement des données...');
                        
                        const [articlesData, usersData, chantiersData] = await Promise.all([
                            window.supabaseDB.getArticles(),
                            window.supabaseDB.getUsers(),
                            window.supabaseDB.getChantiers()
                        ]);
                        
                        console.log('📊 Données récupérées:', {
                            articles: articlesData?.length || 0,
                            users: usersData?.length || 0,
                            chantiers: chantiersData?.length || 0
                        });
                        
                        console.log('🏗️ Chantiers récupérés:', chantiersData);
                        console.log('📦 Articles récupérés:', articlesData);
                        console.log('👥 Utilisateurs récupérés:', usersData);
                        
                        setArticles(articlesData?.length > 0 ? articlesData : initialArticles);
                        setUsers(usersData?.length > 0 ? usersData : initialUsers);
                        setChantiers(chantiersData?.length > 0 ? chantiersData : initialChantiers);
                        
                        console.log('✅ Données chargées avec succès depuis Supabase');
                        
                    } catch (error) {
                        console.error('❌ Erreur lors du chargement des données:', error);
                        setArticles(initialArticles);
                        setUsers(initialUsers);
                        setChantiers(initialChantiers);
                    }
                };
                
                loadData();
            }, []);

            const handleLogin = async (matricule, password) => {
                try {
                    console.log('🔐 Tentative de connexion pour matricule:', matricule);
                    
                    const { data: user, error } = await window.supabaseDB.getUserByMatricule(matricule);
                    
                    if (error) {
                        console.error('Erreur lors de la récupération de l\'utilisateur:', error);
                        alert('Erreur de connexion. Veuillez réessayer.');
                        return;
                    }
                    
                    console.log('📋 Données utilisateur récupérées:', user);
                    
                    if (user && user.length > 0) {
                        const userData = user[0];
                        console.log('👤 Données utilisateur:', userData);
                        
                        if (password === userData.password) {
                            const formattedUser = {
                                matricule: userData.matricule.toString(),
                                nom: userData.nom,
                                role: userData.role,
                                chantier: userData.chantier_id ? `Chantier ${String.fromCharCode(64 + userData.chantier_id)}` : 'Admin'
                            };
                            
                            setCurrentUser(formattedUser);
                            console.log('✅ Connexion réussie:', formattedUser);
                        } else {
                            console.log('❌ Mot de passe incorrect');
                            alert('Mot de passe incorrect.');
                        }
                    } else {
                        console.log('❌ Utilisateur non trouvé');
                        alert('Matricule non trouvé.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la connexion:', error);
                    alert('Erreur de connexion. Veuillez réessayer.');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-lg shadow-md w-96">
                            <h1 className="text-2xl font-bold mb-6 text-center">NE TRAVAUX - DEBUG</h1>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const matricule = e.target.matricule.value;
                                const password = e.target.password.value;
                                handleLogin(matricule, password);
                            }}>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Matricule</label>
                                    <input type="text" name="matricule" className="w-full p-2 border rounded" required />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium mb-2">Mot de passe</label>
                                    <input type="password" name="password" className="w-full p-2 border rounded" required />
                                </div>
                                <button type="submit" className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                                    Se connecter
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h1 className="text-2xl font-bold">NE TRAVAUX - DEBUG</h1>
                                <div className="text-right">
                                    <p className="font-medium">{currentUser.nom}</p>
                                    <p className="text-sm text-gray-600">{currentUser.role}</p>
                                    <button onClick={handleLogout} className="text-blue-500 hover:underline">
                                        Se déconnecter
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-blue-50 p-4 rounded">
                                    <h2 className="font-bold mb-2">Utilisateurs ({users.length})</h2>
                                    <pre className="text-xs overflow-auto">{JSON.stringify(users, null, 2)}</pre>
                                </div>
                                
                                <div className="bg-green-50 p-4 rounded">
                                    <h2 className="font-bold mb-2">Chantiers ({chantiers.length})</h2>
                                    <pre className="text-xs overflow-auto">{JSON.stringify(chantiers, null, 2)}</pre>
                                </div>
                                
                                <div className="bg-yellow-50 p-4 rounded">
                                    <h2 className="font-bold mb-2">Articles ({articles.length})</h2>
                                    <pre className="text-xs overflow-auto">{JSON.stringify(articles, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Rendu de l'application avec React 18
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
