<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NE TRAVAUX - Version Propre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        // Configuration Supabase
        const SUPABASE_URL = 'https://sltmmvuxcanzhqakrtrw.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsdG1tdnV4Y2FuemhxYWtydHJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDk2MDIsImV4cCI6MjA3MDIyNTYwMn0.zlue3-HiLaxu6Frg27pZokTCvW4rlkesT-1RxRyjoxU'

        console.log('üöÄ NE TRAVAUX - VERSION PROPRE - AUCUNE DONN√âE HARCOD√âE');

        // Cr√©er le client Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Fonctions de base de donn√©es
        const supabaseDB = {
            async getUsers() {
                console.log('üîç getUsers appel√©');
                const { data, error } = await supabase.from('users').select('*');
                console.log('üîç getUsers r√©sultat:', { data, error });
                return data || [];
            },

            async getChantiers() {
                console.log('üîç getChantiers appel√©');
                const { data, error } = await supabase.from('chantiers').select('*');
                console.log('üîç getChantiers r√©sultat:', { data, error });
                return data || [];
            },

            async getArticles() {
                console.log('üîç getArticles appel√©');
                const { data, error } = await supabase.from('articles').select('*');
                console.log('üîç getArticles r√©sultat:', { data, error });
                return data || [];
            },

            async getUserByMatricule(matricule) {
                console.log('üîç getUserByMatricule appel√© avec:', matricule);
                const { data, error } = await supabase.from('users').select('*').eq('matricule', matricule);
                console.log('üîç getUserByMatricule r√©sultat:', { data, error });
                return { data, error };
            },

            async addChantier(chantier) {
                console.log('üèóÔ∏è addChantier appel√© avec:', chantier);
                const { data, error } = await supabase.from('chantiers').insert(chantier).select();
                console.log('üèóÔ∏è addChantier r√©sultat:', { data, error });
                return { data, error };
            },

            async addArticle(article) {
                console.log('üì¶ addArticle appel√© avec:', article);
                const { data, error } = await supabase.from('articles').insert(article).select();
                console.log('üì¶ addArticle r√©sultat:', { data, error });
                return { data, error };
            }
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [chantiers, setChantiers] = useState([]);
            const [articles, setArticles] = useState([]);
            const [loading, setLoading] = useState(true);

            // Charger les donn√©es au d√©marrage
            useEffect(() => {
                const loadData = async () => {
                    try {
                        console.log('üöÄ D√©but du chargement des donn√©es...');
                        
                        const [articlesData, usersData, chantiersData] = await Promise.all([
                            supabaseDB.getArticles(),
                            supabaseDB.getUsers(),
                            supabaseDB.getChantiers()
                        ]);
                        
                        console.log('üìä Donn√©es r√©cup√©r√©es:', {
                            articles: articlesData?.length || 0,
                            users: usersData?.length || 0,
                            chantiers: chantiersData?.length || 0
                        });
                        
                        setArticles(articlesData);
                        setUsers(usersData);
                        setChantiers(chantiersData);
                        setLoading(false);
                        
                        console.log('‚úÖ Donn√©es charg√©es avec succ√®s depuis Supabase');
                        
                    } catch (error) {
                        console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                        setLoading(false);
                    }
                };
                
                loadData();
            }, []);

            const handleLogin = async (matricule, password) => {
                try {
                    console.log('üîê Tentative de connexion pour matricule:', matricule);
                    
                    const { data: user, error } = await supabaseDB.getUserByMatricule(matricule);
                    
                    if (error) {
                        console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur:', error);
                        alert('Erreur de connexion. Veuillez r√©essayer.');
                        return;
                    }
                    
                    console.log('üìã Donn√©es utilisateur r√©cup√©r√©es:', user);
                    
                    if (user && user.length > 0) {
                        const userData = user[0];
                        console.log('üë§ Donn√©es utilisateur:', userData);
                        
                        if (password === userData.password) {
                            const formattedUser = {
                                matricule: userData.matricule.toString(),
                                nom: userData.nom,
                                role: userData.role,
                                chantier: userData.chantier_id ? `Chantier ${String.fromCharCode(64 + userData.chantier_id)}` : 'Admin'
                            };
                            
                            setCurrentUser(formattedUser);
                            console.log('‚úÖ Connexion r√©ussie:', formattedUser);
                        } else {
                            console.log('‚ùå Mot de passe incorrect');
                            alert('Mot de passe incorrect.');
                        }
                    } else {
                        console.log('‚ùå Utilisateur non trouv√©');
                        alert('Matricule non trouv√©.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la connexion:', error);
                    alert('Erreur de connexion. Veuillez r√©essayer.');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
            };

            const handleAddChantier = async () => {
                const nom = prompt('Nom du chantier:');
                if (nom) {
                    try {
                        const result = await supabaseDB.addChantier({
                            nom: nom,
                            description: 'Nouveau chantier',
                            icone: 'üèóÔ∏è'
                        });
                        
                        if (result.error) {
                            alert('Erreur lors de l\'ajout du chantier: ' + result.error.message);
                        } else {
                            alert('Chantier ajout√© avec succ√®s !');
                            // Recharger les donn√©es
                            const newChantiers = await supabaseDB.getChantiers();
                            setChantiers(newChantiers);
                        }
                    } catch (error) {
                        alert('Erreur: ' + error.message);
                    }
                }
            };

            const handleAddArticle = async () => {
                const nom = prompt('Nom de l\'article:');
                const quantite = prompt('Quantit√©:');
                const chantierId = prompt('ID du chantier:');
                
                if (nom && quantite && chantierId) {
                    try {
                        const result = await supabaseDB.addArticle({
                            nom: nom,
                            quantite: parseInt(quantite),
                            icone: 'üì¶',
                            chantier_id: parseInt(chantierId)
                        });
                        
                        if (result.error) {
                            alert('Erreur lors de l\'ajout de l\'article: ' + result.error.message);
                        } else {
                            alert('Article ajout√© avec succ√®s !');
                            // Recharger les donn√©es
                            const newArticles = await supabaseDB.getArticles();
                            setArticles(newArticles);
                        }
                    } catch (error) {
                        alert('Erreur: ' + error.message);
                    }
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Chargement des donn√©es depuis Supabase...</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-lg shadow-md w-96">
                            <h1 className="text-2xl font-bold mb-6 text-center">NE TRAVAUX - VERSION PROPRE</h1>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const matricule = e.target.matricule.value;
                                const password = e.target.password.value;
                                handleLogin(matricule, password);
                            }}>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Matricule</label>
                                    <input type="text" name="matricule" className="w-full p-2 border rounded" required />
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium mb-2">Mot de passe</label>
                                    <input type="password" name="password" className="w-full p-2 border rounded" required />
                                </div>
                                <button type="submit" className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                                    Se connecter
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h1 className="text-2xl font-bold">NE TRAVAUX - VERSION PROPRE</h1>
                                <div className="text-right">
                                    <p className="font-medium">{currentUser.nom}</p>
                                    <p className="text-sm text-gray-600">{currentUser.role}</p>
                                    <button onClick={handleLogout} className="text-blue-500 hover:underline">
                                        Se d√©connecter
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div className="bg-blue-50 p-4 rounded">
                                    <h2 className="font-bold mb-2">Utilisateurs ({users.length})</h2>
                                    <pre className="text-xs overflow-auto">{JSON.stringify(users, null, 2)}</pre>
                                </div>
                                
                                <div className="bg-green-50 p-4 rounded">
                                    <h2 className="font-bold mb-2">Chantiers ({chantiers.length})</h2>
                                    <pre className="text-xs overflow-auto">{JSON.stringify(chantiers, null, 2)}</pre>
                                </div>
                                
                                <div className="bg-yellow-50 p-4 rounded">
                                    <h2 className="font-bold mb-2">Articles ({articles.length})</h2>
                                    <pre className="text-xs overflow-auto">{JSON.stringify(articles, null, 2)}</pre>
                                </div>
                            </div>

                            {currentUser.role === 'admin' && (
                                <div className="flex gap-4">
                                    <button onClick={handleAddChantier} className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                        Ajouter un chantier
                                    </button>
                                    <button onClick={handleAddArticle} className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                        Ajouter un article
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Rendu de l'application avec React 18
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
