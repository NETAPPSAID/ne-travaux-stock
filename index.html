<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NE TRAVAUX - Gestion de Stock</title>
    
    <!-- TEST: Ceci confirme qu'on utilise index.html -->
    <script>
        console.log('üéØ FICHIER INDEX.HTML CHARG√â - Version corrig√©e');
        console.log('üéØ URL actuelle:', window.location.href);
        
        // FORCER LA MISE √Ä JOUR DU SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    console.log('üîÑ Mise √† jour forc√©e du Service Worker...');
                    registration.update();
                }
            });
            
            // VIDER LES CACHES EXISTANTS
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            console.log('üóëÔ∏è Suppression du cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                });
            }
        }
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React et ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel pour JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>
    
    <!-- jsPDF pour g√©n√©ration de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Styles pour mobile */
        @media (max-width: 768px) {
            .mobile-full-width {
                width: 100% !important;
            }
            
            .mobile-stack {
                display: flex !important;
                flex-direction: column !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-grid-1 {
                grid-template-columns: 1fr !important;
            }
            
            .mobile-tab-full {
                width: 100% !important;
                justify-content: center !important;
            }
            
            .mobile-form-stack > div {
                margin-bottom: 1rem !important;
            }
        }
        
        /* Am√©lioration de l'exp√©rience tactile */
        @media (hover: none) and (pointer: coarse) {
            button, input, select, textarea {
                min-height: 44px !important;
            }
            
            .touch-target {
                min-width: 44px !important;
                min-height: 44px !important;
            }
        }
        
        /* Animation de chargement */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <!-- Supabase Client Int√©gr√© -->
    <script>
        // Attendre que la page soit compl√®tement charg√©e
        window.addEventListener('load', function() {
            console.log('üîß D√©but du chargement du client Supabase...');
            
            // Attendre un peu pour s'assurer que Supabase est charg√©
            setTimeout(() => {
                // V√©rifier que createClient est disponible
                if (typeof window.supabase === 'undefined' && typeof createClient === 'undefined') {
                    console.error('‚ùå Supabase non disponible - Biblioth√®que non charg√©e');
                    alert('Erreur: Biblioth√®que Supabase non charg√©e. V√©rifiez votre connexion internet.');
                    return;
                } else {
                    console.log('‚úÖ Supabase disponible');
                }
                
                const SUPABASE_URL = 'https://sltmmvuxcanzhqakrtrw.supabase.co'
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsdG1tdnV4Y2FuemhxYWtydHJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDk2MDIsImV4cCI6MjA3MDIyNTYwMn0.zlue3-HiLaxu6Frg27pZokTCvW4rlkesT-1RxRyjoxU'

                console.log('üîß Configuration Supabase int√©gr√©e:', {
                    url: SUPABASE_URL,
                    key: SUPABASE_ANON_KEY ? 'PR√âSENT' : 'MANQUANT'
                })

                try {
                    // Utiliser la fonction disponible
                    const createClientFn = window.supabase?.createClient || createClient;
                    
                    // Cr√©er le client Supabase
                    const supabase = createClientFn(SUPABASE_URL, SUPABASE_ANON_KEY)
                    console.log('‚úÖ Client Supabase cr√©√© avec succ√®s');

                    // Fonctions de base de donn√©es int√©gr√©es
                    window.supabaseDB = {
                        // ===== GESTION DES UTILISATEURS =====
                        async getUsers() {
                            try {
                                const { data, error } = await supabase
                                    .from('users')
                                    .select('*')
                                console.log('üìä getUsers r√©sultat:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå Erreur getUsers:', err);
                                return []
                            }
                        },

                        async getUserByMatricule(matricule) {
                            try {
                                console.log('üîç Recherche utilisateur matricule:', matricule);
                                const { data, error } = await supabase
                                    .from('users')
                                    .select('*')
                                    .eq('matricule', matricule)
                                console.log('üîç getUserByMatricule r√©sultat:', { data: data?.length || 0, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå Erreur getUserByMatricule:', err);
                                return { data: null, error: err }
                            }
                        },

                        // ===== GESTION DES CHANTIERS =====
                        async getChantiers() {
                            try {
                                const { data, error } = await supabase
                                    .from('chantiers')
                                    .select('*')
                                console.log('üìä getChantiers r√©sultat:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå Erreur getChantiers:', err);
                                return []
                            }
                        },

                        async addChantier(chantier) {
                            try {
                                console.log('üèóÔ∏è Tentative d\'ajout chantier:', chantier)
                                const { data, error } = await supabase
                                    .from('chantiers')
                                    .insert(chantier)
                                    .select()
                                console.log('üèóÔ∏è R√©sultat ajout chantier:', { data, error })
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå Erreur addChantier:', err);
                                return { data: null, error: err }
                            }
                        },

                        async deleteChantier(id) {
                            try {
                                console.log('üóëÔ∏è [SUPABASE] D√©but suppression chantier ID:', id);
                                const { data, error } = await supabase
                                    .from('chantiers')
                                    .delete()
                                    .eq('id', id)
                                    .select()
                                console.log('üóëÔ∏è [SUPABASE] R√©sultat suppression chantier:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur deleteChantier:', err);
                                return { data: null, error: err }
                            }
                        },

                        // ===== GESTION DES ARTICLES =====
                        async getArticles() {
                            try {
                                const { data, error } = await supabase
                                    .from('articles')
                                    .select('*')
                                console.log('üìä getArticles r√©sultat:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå Erreur getArticles:', err);
                                return []
                            }
                        },

                        async addArticle(article) {
                            try {
                                const { data, error } = await supabase
                                    .from('articles')
                                    .insert(article)
                                    .select()
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå Erreur addArticle:', err);
                                return { data: null, error: err }
                            }
                        },

                        async deleteArticle(id) {
                            try {
                                console.log('üóëÔ∏è [SUPABASE] D√©but suppression article ID:', id);
                                const { data, error } = await supabase
                                    .from('articles')
                                    .delete()
                                    .eq('id', id)
                                    .select()
                                console.log('üóëÔ∏è [SUPABASE] R√©sultat suppression article:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur deleteArticle:', err);
                                return { data: null, error: err }
                            }
                        },

                        async updateArticle(id, updates) {
                            try {
                                console.log('üîÑ [SUPABASE] Mise √† jour article ID:', id, 'Updates:', updates);
                                const { data, error } = await supabase
                                    .from('articles')
                                    .update(updates)
                                    .eq('id', id)
                                    .select()
                                console.log('üîÑ [SUPABASE] R√©sultat mise √† jour article:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur updateArticle:', err);
                                return { data: null, error: err }
                            }
                        },

                        // ===== GESTION DES UTILISATEURS =====
                        async addUser(user) {
                            try {
                                console.log('üë§ [SUPABASE] Tentative d\'ajout utilisateur:', user);
                                const userData = {
                                    ...user,
                                    role: 'pointeur',
                                    matricule: parseInt(user.matricule)
                                };
                                const { data, error } = await supabase
                                    .from('users')
                                    .insert(userData)
                                    .select()
                                console.log('üë§ [SUPABASE] R√©sultat ajout utilisateur:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur addUser:', err);
                                return { data: null, error: err }
                            }
                        },

                        async deleteUser(matricule) {
                            try {
                                console.log('üóëÔ∏è [SUPABASE] D√©but suppression utilisateur matricule:', matricule);
                                const { data, error } = await supabase
                                    .from('users')
                                    .delete()
                                    .eq('matricule', matricule)
                                    .select()
                                console.log('üóëÔ∏è [SUPABASE] R√©sultat suppression utilisateur:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur deleteUser:', err);
                                return { data: null, error: err }
                            }
                        },

                        // ===== GESTION DES ENTR√âES =====
                        async addEntree(entree) {
                            try {
                                console.log('üì• [SUPABASE] Tentative d\'ajout entr√©e:', entree);
                                const { data, error } = await supabase
                                    .from('entrees')
                                    .insert(entree)
                                    .select()
                                console.log('üì• [SUPABASE] R√©sultat ajout entr√©e:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur addEntree:', err);
                                return { data: null, error: err }
                            }
                        },

                        async getEntrees(chantier_id = null) {
                            try {
                                let query = supabase.from('entrees').select('*');
                                if (chantier_id) {
                                    query = query.eq('chantier_id', chantier_id);
                                }
                                const { data, error } = await query;
                                console.log('üì• [SUPABASE] R√©sultat getEntrees:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur getEntrees:', err);
                                return []
                            }
                        },

                        async updateEntree(id, updates) {
                            try {
                                console.log('üîÑ [SUPABASE] Mise √† jour entr√©e ID:', id, 'Updates:', updates);
                                const { data, error } = await supabase
                                    .from('entrees')
                                    .update(updates)
                                    .eq('id', id)
                                    .select()
                                console.log('üîÑ [SUPABASE] R√©sultat mise √† jour entr√©e:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur updateEntree:', err);
                                return { data: null, error: err }
                            }
                        },

                        // ===== GESTION DES SORTIES =====
                        async addSortie(sortie) {
                            try {
                                console.log('üì§ [SUPABASE] Tentative d\'ajout sortie:', sortie);
                                const { data, error } = await supabase
                                    .from('sorties')
                                    .insert(sortie)
                                    .select()
                                console.log('üì§ [SUPABASE] R√©sultat ajout sortie:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur addSortie:', err);
                                return { data: null, error: err }
                            }
                        },

                        async getSorties(chantier_id = null) {
                            try {
                                let query = supabase.from('sorties').select('*');
                                if (chantier_id) {
                                    query = query.eq('chantier_id', chantier_id);
                                }
                                const { data, error } = await query;
                                console.log('üì§ [SUPABASE] R√©sultat getSorties:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur getSorties:', err);
                                return []
                            }
                        },

                        // ===== GESTION DES COMMANDES =====
                        async addCommande(commande) {
                            try {
                                console.log('üìã [SUPABASE] Tentative d\'ajout commande:', commande);
                                const { data, error } = await supabase
                                    .from('commandes')
                                    .insert(commande)
                                    .select()
                                console.log('üìã [SUPABASE] R√©sultat ajout commande:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur addCommande:', err);
                                return { data: null, error: err }
                            }
                        },

                        async getCommandes(chantier_id = null) {
                            try {
                                let query = supabase.from('commandes').select('*');
                                if (chantier_id) {
                                    query = query.eq('chantier_id', chantier_id);
                                }
                                const { data, error } = await query;
                                console.log('üìã [SUPABASE] R√©sultat getCommandes:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur getCommandes:', err);
                                return []
                            }
                        },

                        // ===== FONCTIONS SUPPL√âMENTAIRES =====
                        async updateCommandeStatus(id, statut) {
                            try {
                                console.log('üìã [SUPABASE] Mise √† jour statut commande:', { id, statut });
                                const { data, error } = await supabase
                                    .from('commandes')
                                    .update({ statut })
                                    .eq('id', id)
                                    .select()
                                console.log('üìã [SUPABASE] R√©sultat mise √† jour commande:', { data, error });
                                return { data, error }
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur updateCommandeStatus:', err);
                                return { data: null, error: err }
                            }
                        },

                        async getEntreesByChantier(chantier_id) {
                            try {
                                const { data, error } = await supabase
                                    .from('entrees')
                                    .select(`
                                        *,
                                        articles(nom, icone),
                                        users(nom)
                                    `)
                                    .eq('chantier_id', chantier_id)
                                console.log('üì• [SUPABASE] R√©sultat getEntreesByChantier:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur getEntreesByChantier:', err);
                                return []
                            }
                        },

                        async getSortiesByChantier(chantier_id) {
                            try {
                                const { data, error } = await supabase
                                    .from('sorties')
                                    .select(`
                                        *,
                                        articles(nom, icone),
                                        users(nom)
                                    `)
                                    .eq('chantier_id', chantier_id)
                                console.log('üì§ [SUPABASE] R√©sultat getSortiesByChantier:', { data: data?.length || 0, error });
                                return data || []
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur getSortiesByChantier:', err);
                                return []
                            }
                        },

                        // ===== FONCTIONS STORAGE =====
                        async uploadBonEntree(file, entreeId) {
                            try {
                                console.log('üì§ [SUPABASE] Upload bon entr√©e:', { fileName: file.name, entreeId });
                                
                                const fileExt = file.name.split('.').pop();
                                const fileName = `bon-entree-${entreeId}-${Date.now()}.${fileExt}`;
                                const filePath = `bons-entree/${fileName}`;
                                
                                const { data, error } = await supabase.storage
                                    .from('ne-travaux-storage')
                                    .upload(filePath, file);
                                
                                if (error) {
                                    console.error('‚ùå [SUPABASE] Erreur upload:', error);
                                    return { data: null, error };
                                }
                                
                                // Obtenir l'URL publique
                                const { data: urlData } = supabase.storage
                                    .from('ne-travaux-storage')
                                    .getPublicUrl(filePath);
                                
                                console.log('‚úÖ [SUPABASE] Upload r√©ussi:', urlData.publicUrl);
                                return { data: urlData.publicUrl, error: null };
                                
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur uploadBonEntree:', err);
                                return { data: null, error: err };
                            }
                        },

                        async getBonEntreeUrl(entreeId) {
                            try {
                                const { data, error } = await supabase
                                    .from('entrees')
                                    .select('bon_entree_url')
                                    .eq('id', entreeId)
                                    .single();
                                
                                return { data: data?.bon_entree_url, error };
                            } catch (err) {
                                console.error('‚ùå [SUPABASE] Erreur getBonEntreeUrl:', err);
                                return { data: null, error: err };
                            }
                        }
                    }

                    console.log('‚úÖ Supabase client int√©gr√© charg√© avec succ√®s')
                    console.log('‚úÖ window.supabaseDB disponible:', !!window.supabaseDB)
                    
                    // SYNCHRONISATION TEMPS R√âEL COMPL√àTEMENT D√âSACTIV√âE
                    console.log('üö´ Synchronisation temps r√©el D√âSACTIV√âE - Pas de rechargement automatique')
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de la cr√©ation du client Supabase:', error);
                    alert('Erreur lors de l\'initialisation de la base de donn√©es: ' + error.message);
                }
            }, 1000); // Attendre 1 seconde
        });
    </script>
    
    <!-- App Component -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        console.log('üöÄ NE TRAVAUX - Gestion de Stock');

        // Composant de connexion
        function Login({ onLogin }) {
            const [matricule, setMatricule] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (matricule.trim() && password.trim()) {
                    onLogin(matricule, password);
                }
            };

            return (
                <div className="min-h-screen bg-cover bg-center bg-no-repeat flex items-center justify-center p-4 relative overflow-hidden" style={{backgroundImage: 'url("./background.jpg.jpg")'}}>
                    <div className="absolute inset-0 bg-black/50"></div>
                    
                    <div className="bg-white/20 backdrop-blur-sm rounded-2xl shadow-2xl p-8 w-full max-w-md relative z-10 border-2 border-white/50">
                        <div className="text-center mb-8">
                            <div className="mb-4">
                                <div className="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                    <img src="./logo.jpg.jpg" alt="Logo" className="w-16 h-16 object-contain rounded-full" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                                    <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl" style={{display: 'none'}}>NEK</div>
                                </div>
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">NAIT EL KHALFAOUI TRAVAUX</h1>
                            <p className="text-white/80 text-lg">Gestion de Stock</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-white font-medium mb-2">Matricule</label>
                                <input
                                    type="text"
                                    value={matricule}
                                    onChange={(e) => setMatricule(e.target.value)}
                                    className="w-full px-4 py-3 bg-white/90 backdrop-blur-sm border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 placeholder-gray-500"
                                    placeholder="Entrez votre matricule"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-white font-medium mb-2">Mot de passe</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-white/90 backdrop-blur-sm border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 placeholder-gray-500"
                                    placeholder="Entrez votre mot de passe"
                                    required
                                />
                            </div>
                            
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg"
                            >
                                Se connecter
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Composant principal de l'application
        function App() {
            const { useState, useEffect, useCallback, useRef } = React;
            
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('stock');
            const [users, setUsers] = useState([]);
            const [chantiers, setChantiers] = useState([]);
            const [articles, setArticles] = useState([]);
            const [loading, setLoading] = useState(false);
            
            // Nouveaux √©tats pour les fonctionnalit√©s pointeur
            const [entrees, setEntrees] = useState([]);
            const [sorties, setSorties] = useState([]);
            const [commandes, setCommandes] = useState([]);
            
            // √âtats pour les filtres
            const [filterChantier, setFilterChantier] = useState('');
            const [filterPointeur, setFilterPointeur] = useState('');
            const [filterDate, setFilterDate] = useState('');
            
            // Utiliser useRef pour √©viter les re-renders
            const chantierFormRef = useRef({ nom: '', description: '', icone: 'üèóÔ∏è' });
            const articleFormRef = useRef({ nom: '', quantite: '', icone: 'üì¶', chantier_id: '' });
            const userFormRef = useRef({ nom: '', matricule: '', password: '', chantier_id: '' });
            
            // Nouveaux refs pour les formulaires pointeur
            const entreeFormRef = useRef({ article_id: '', quantite: '', date: '', bon_entree: '' });
            const sortieFormRef = useRef({ article_id: '', quantite: '', date: '', motif: '' });
            const commandeFormRef = useRef({ article_nom: '', quantite: '', message: '' });

            // Fonction pour recharger TOUTES les donn√©es depuis Supabase
            const reloadAllData = useCallback(async () => {
                try {
                    console.log('üîÑ Rechargement complet des donn√©es depuis Supabase...');
                    console.log('üîÑ V√©rification de supabaseDB:', !!window.supabaseDB);
                    setLoading(true);
                    
                    // Recharger depuis Supabase avec v√©rification
                    console.log('üîÑ Appel de getArticles...');
                    const articlesData = await window.supabaseDB.getArticles();
                    console.log('üîÑ Appel de getUsers...');
                    const usersData = await window.supabaseDB.getUsers();
                    console.log('üîÑ Appel de getChantiers...');
                    const chantiersData = await window.supabaseDB.getChantiers();
                    
                    // Charger les donn√©es pointeur si l'utilisateur est connect√©
                    let entreesData = [];
                    let sortiesData = [];
                    let commandesData = [];
                    
                    if (currentUser) {
                        console.log('üîÑ Appel de getEntrees...');
                        entreesData = await window.supabaseDB.getEntrees();
                        console.log('üîÑ Appel de getSorties...');
                        sortiesData = await window.supabaseDB.getSorties();
                        console.log('üîÑ Appel de getCommandes...');
                        commandesData = await window.supabaseDB.getCommandes();
                    }
                    
                    console.log('üìä Donn√©es recharg√©es:', {
                        articles: articlesData?.length || 0,
                        users: usersData?.length || 0,
                        chantiers: chantiersData?.length || 0,
                        entrees: entreesData?.length || 0,
                        sorties: sortiesData?.length || 0,
                        commandes: commandesData?.length || 0
                    });
                    
                    // Mettre √† jour les √©tats
                    setArticles(articlesData || []);
                    setUsers(usersData || []);
                    setChantiers(chantiersData || []);
                    setEntrees(entreesData || []);
                    setSorties(sortiesData || []);
                    setCommandes(commandesData || []);
                    setLoading(false);
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors du rechargement:', error);
                    setLoading(false);
                }
            }, [currentUser]);

            // Charger les donn√©es au d√©marrage
            useEffect(() => {
                if (currentUser) {
                    reloadAllData();
                }
            }, [currentUser, reloadAllData]);

            const handleLogin = async (matricule, password) => {
                try {
                    console.log('üîê Tentative de connexion pour matricule:', matricule);
                    
                    // V√©rifier que supabaseDB est disponible
                    if (!window.supabaseDB) {
                        console.error('‚ùå supabaseDB non disponible');
                        alert('Erreur: Connexion √† la base de donn√©es impossible');
                        return;
                    }
                    
                    const { data, error } = await window.supabaseDB.getUserByMatricule(matricule);
                    
                    if (error) {
                        console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur:', error);
                        alert('Erreur de connexion. Veuillez r√©essayer.');
                        return;
                    }
                    
                    console.log('üìã Donn√©es utilisateur r√©cup√©r√©es:', data);
                    
                    if (data && data.length > 0) {
                        const userData = data[0];
                        console.log('üë§ Donn√©es utilisateur:', userData);
                        
                        if (password === userData.password) {
                            // Trouver le nom du chantier √† partir de l'ID
                            let chantierNom = 'Admin';
                            if (userData.chantier_id) {
                                // Charger les chantiers pour obtenir le nom
                                const chantiersData = await window.supabaseDB.getChantiers();
                                const chantier = chantiersData.find(c => c.id === userData.chantier_id);
                                chantierNom = chantier ? chantier.nom : `Chantier ${userData.chantier_id}`;
                            }
                            
                            const formattedUser = {
                                matricule: userData.matricule.toString(),
                                nom: userData.nom,
                                role: userData.role,
                                chantier: chantierNom
                            };
                            
                            setCurrentUser(formattedUser);
                            console.log('‚úÖ Connexion r√©ussie:', formattedUser);
                        } else {
                            console.log('‚ùå Mot de passe incorrect');
                            alert('Mot de passe incorrect.');
                        }
                    } else {
                        console.log('‚ùå Utilisateur non trouv√©');
                        alert('Matricule non trouv√©.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la connexion:', error);
                    alert('Erreur de connexion. Veuillez r√©essayer.');
                }
            };

            const handleLogout = () => {
                console.log('üö™ D√©connexion - Nettoyage des donn√©es locales');
                setCurrentUser(null);
                setActiveTab('stock');
                // Vider compl√®tement les donn√©es locales
                setArticles([]);
                setUsers([]);
                setChantiers([]);
            };

            // Fonctions de gestion des donn√©es
            const handleAddChantier = async () => {
                try {
                    console.log('ÔøΩÔøΩÔ∏è Ajout chantier:', chantierFormRef.current);
                    
                    const { data, error } = await window.supabaseDB.addChantier(chantierFormRef.current);
                    
                    if (error) {
                        console.error('Erreur lors de l\'ajout du chantier:', error);
                        alert('Erreur lors de l\'ajout du chantier: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Chantier ajout√© avec succ√®s:', data);
                    
                    // Recharger les donn√©es depuis Supabase
                    await reloadAllData();
                    
                    // R√©initialiser le formulaire
                    chantierFormRef.current = { nom: '', description: '', icone: 'üèóÔ∏è' };
                    
                } catch (error) {
                    console.error('Erreur lors de l\'ajout du chantier:', error);
                    alert('Erreur lors de l\'ajout du chantier: ' + error.message);
                }
            };

            const handleDeleteChantier = async (id) => {
                try {
                    console.log('üóëÔ∏è Suppression chantier ID:', id);
                    console.log('üóëÔ∏è V√©rification de supabaseDB:', !!window.supabaseDB);
                    
                    const { data, error } = await window.supabaseDB.deleteChantier(id);
                    
                    console.log('üóëÔ∏è R√©sultat suppression chantier:', { data, error });
                    
                    if (error) {
                        console.error('Erreur lors de la suppression du chantier:', error);
                        alert('Erreur lors de la suppression du chantier: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Chantier supprim√© avec succ√®s:', data);
                    
                    // Recharger les donn√©es depuis Supabase
                    console.log('üîÑ Rechargement apr√®s suppression chantier...');
                    await reloadAllData();
                    
                } catch (error) {
                    console.error('Erreur lors de la suppression du chantier:', error);
                    alert('Erreur lors de la suppression du chantier: ' + error.message);
                }
            };

            const handleAddArticle = async () => {
                try {
                    console.log('üì¶ Ajout article:', articleFormRef.current);
                    
                    // Convertir la quantit√© en nombre et g√©rer chantier_id vide
                    const articleData = {
                        ...articleFormRef.current,
                        quantite: parseInt(articleFormRef.current.quantite) || 0,
                        chantier_id: articleFormRef.current.chantier_id === '' ? null : parseInt(articleFormRef.current.chantier_id)
                    };
                    
                    console.log('üì¶ Donn√©es article pr√©par√©es:', articleData);
                    
                    const { data, error } = await window.supabaseDB.addArticle(articleData);
                    
                    if (error) {
                        console.error('Erreur lors de l\'ajout de l\'article:', error);
                        alert('Erreur lors de l\'ajout de l\'article: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Article ajout√© avec succ√®s:', data);
                    
                    // Recharger les donn√©es depuis Supabase
                    await reloadAllData();
                    
                    // R√©initialiser le formulaire
                    articleFormRef.current = { nom: '', quantite: '', icone: 'üì¶', chantier_id: '' };
                    
                } catch (error) {
                    console.error('Erreur lors de l\'ajout de l\'article:', error);
                    alert('Erreur lors de l\'ajout de l\'article: ' + error.message);
                }
            };

            const handleDeleteArticle = async (id) => {
                try {
                    console.log('üóëÔ∏è Suppression article ID:', id);
                    console.log('üóëÔ∏è V√©rification de supabaseDB:', !!window.supabaseDB);
                    
                    const { data, error } = await window.supabaseDB.deleteArticle(id);
                    
                    console.log('üóëÔ∏è R√©sultat suppression article:', { data, error });
                    
                    if (error) {
                        console.error('Erreur lors de la suppression de l\'article:', error);
                        alert('Erreur lors de la suppression de l\'article: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Article supprim√© avec succ√®s:', data);
                    
                    // Recharger les donn√©es depuis Supabase
                    console.log('üîÑ Rechargement apr√®s suppression article...');
                    await reloadAllData();
                    
                } catch (error) {
                    console.error('Erreur lors de la suppression de l\'article:', error);
                    alert('Erreur lors de la suppression de l\'article: ' + error.message);
                }
            };

            const handleAddUser = async () => {
                try {
                    console.log('üë§ Ajout utilisateur:', userFormRef.current);
                    
                    // V√©rifier si le matricule existe d√©j√†
                    const matricule = parseInt(userFormRef.current.matricule);
                    const existingUser = users.find(user => user.matricule === matricule);
                    
                    if (existingUser) {
                        alert('Erreur: Un utilisateur avec ce matricule existe d√©j√†. Veuillez utiliser un matricule diff√©rent.');
                        return;
                    }
                    
                    const { data, error } = await window.supabaseDB.addUser(userFormRef.current);
                    
                    if (error) {
                        console.error('Erreur lors de l\'ajout de l\'utilisateur:', error);
                        alert('Erreur lors de l\'ajout de l\'utilisateur: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Utilisateur ajout√© avec succ√®s:', data);
                    alert('‚úÖ Pointeur cr√©√© avec succ√®s !');
                    
                    // Recharger les donn√©es depuis Supabase
                    await reloadAllData();
                    
                    // R√©initialiser le formulaire
                    userFormRef.current = { nom: '', matricule: '', password: '', chantier_id: '' };
                    
                } catch (error) {
                    console.error('Erreur lors de l\'ajout de l\'utilisateur:', error);
                    alert('Erreur lors de l\'ajout de l\'utilisateur: ' + error.message);
                }
            };

            const handleDeleteUser = async (matricule) => {
                try {
                    console.log('üóëÔ∏è Suppression utilisateur matricule:', matricule);
                    console.log('üóëÔ∏è V√©rification de supabaseDB:', !!window.supabaseDB);
                    
                    const { data, error } = await window.supabaseDB.deleteUser(matricule);
                    
                    console.log('üóëÔ∏è R√©sultat suppression utilisateur:', { data, error });
                    
                    if (error) {
                        console.error('Erreur lors de la suppression de l\'utilisateur:', error);
                        alert('Erreur lors de la suppression de l\'utilisateur: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Utilisateur supprim√© avec succ√®s:', data);
                    
                    // Recharger les donn√©es depuis Supabase
                    console.log('üîÑ Rechargement apr√®s suppression utilisateur...');
                    await reloadAllData();
                    
                } catch (error) {
                    console.error('Erreur lors de la suppression de l\'utilisateur:', error);
                    alert('Erreur lors de la suppression de l\'utilisateur: ' + error.message);
                }
            };

            // ===== FONCTIONS DE GESTION POINTEUR =====
            
            const handleAddEntree = async () => {
                try {
                    console.log('üì• Ajout entr√©e:', entreeFormRef.current);
                    
                    if (!entreeFormRef.current.article_id || !entreeFormRef.current.quantite) {
                        alert('Veuillez remplir tous les champs obligatoires.');
                        return;
                    }
                    
                    // Trouver l'ID du chantier √† partir du nom
                    const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                    const chantier = chantiers.find(c => c.nom === userChantier);
                    const chantier_id = chantier ? chantier.id : null;
                    
                    if (!chantier_id) {
                        alert('Erreur: Impossible de d√©terminer le chantier.');
                        return;
                    }
                    
                    const entreeData = {
                        article_id: parseInt(entreeFormRef.current.article_id),
                        chantier_id: chantier_id,
                        quantite: parseInt(entreeFormRef.current.quantite),
                        date_entree: entreeFormRef.current.date || new Date().toISOString(),
                        bon_entree_url: null, // Sera mis √† jour apr√®s upload
                        pointeur_matricule: parseInt(currentUser.matricule)
                    };
                    
                    console.log('üì• Donn√©es entr√©e pr√©par√©es:', entreeData);
                    
                    const { data, error } = await window.supabaseDB.addEntree(entreeData);
                    
                    if (error) {
                        console.error('Erreur lors de l\'ajout de l\'entr√©e:', error);
                        alert('Erreur lors de l\'ajout de l\'entr√©e: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Entr√©e ajout√©e avec succ√®s:', data);
                    
                    // Upload du bon d'entr√©e si un fichier est s√©lectionn√©
                    if (entreeFormRef.current.bon_entree_file) {
                        console.log('üì§ Upload du bon d\'entr√©e...');
                        const { data: uploadData, error: uploadError } = await window.supabaseDB.uploadBonEntree(
                            entreeFormRef.current.bon_entree_file, 
                            data[0].id
                        );
                        
                        if (uploadError) {
                            console.error('Erreur lors de l\'upload:', uploadError);
                            alert('Entr√©e enregistr√©e mais erreur lors de l\'upload du bon d\'entr√©e.');
                        } else {
                            // Mettre √† jour l'entr√©e avec l'URL du bon
                            await window.supabaseDB.updateEntree(data[0].id, { bon_entree_url: uploadData });
                            console.log('‚úÖ Bon d\'entr√©e upload√© avec succ√®s');
                        }
                    }
                    
                    alert('‚úÖ Entr√©e enregistr√©e avec succ√®s !');
                    
                    // Mettre √† jour le stock de l'article
                    const article = articles.find(a => a.id === entreeData.article_id);
                    if (article) {
                        const newQuantite = article.quantite + entreeData.quantite;
                        await window.supabaseDB.updateArticle(entreeData.article_id, { quantite: newQuantite });
                    }
                    
                    // Recharger les donn√©es
                    await reloadAllData();
                    
                    // R√©initialiser le formulaire
                    entreeFormRef.current = { article_id: '', quantite: '', date: '', bon_entree_file: null };
                    
                } catch (error) {
                    console.error('Erreur lors de l\'ajout de l\'entr√©e:', error);
                    alert('Erreur lors de l\'ajout de l\'entr√©e: ' + error.message);
                }
            };

            const handleAddSortie = async () => {
                try {
                    console.log('üì§ Ajout sortie:', sortieFormRef.current);
                    
                    if (!sortieFormRef.current.article_id || !sortieFormRef.current.quantite) {
                        alert('Veuillez remplir tous les champs obligatoires.');
                        return;
                    }
                    
                    // Trouver l'ID du chantier √† partir du nom
                    const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                    const chantier = chantiers.find(c => c.nom === userChantier);
                    const chantier_id = chantier ? chantier.id : null;
                    
                    if (!chantier_id) {
                        alert('Erreur: Impossible de d√©terminer le chantier.');
                        return;
                    }
                    
                    // V√©rifier le stock disponible
                    const article = articles.find(a => a.id === parseInt(sortieFormRef.current.article_id));
                    if (article && article.quantite < parseInt(sortieFormRef.current.quantite)) {
                        alert('Erreur: Stock insuffisant. Stock disponible: ' + article.quantite);
                        return;
                    }
                    
                    const sortieData = {
                        article_id: parseInt(sortieFormRef.current.article_id),
                        chantier_id: chantier_id,
                        quantite: parseInt(sortieFormRef.current.quantite),
                        date_sortie: sortieFormRef.current.date || new Date().toISOString(),
                        motif: sortieFormRef.current.motif || null,
                        pointeur_matricule: parseInt(currentUser.matricule)
                    };
                    
                    console.log('üì§ Donn√©es sortie pr√©par√©es:', sortieData);
                    
                    const { data, error } = await window.supabaseDB.addSortie(sortieData);
                    
                    if (error) {
                        console.error('Erreur lors de l\'ajout de la sortie:', error);
                        alert('Erreur lors de l\'ajout de la sortie: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Sortie ajout√©e avec succ√®s:', data);
                    alert('‚úÖ Sortie enregistr√©e avec succ√®s !');
                    
                    // Mettre √† jour le stock de l'article
                    if (article) {
                        const newQuantite = article.quantite - sortieData.quantite;
                        await window.supabaseDB.updateArticle(sortieData.article_id, { quantite: newQuantite });
                    }
                    
                    // Recharger les donn√©es
                    await reloadAllData();
                    
                    // R√©initialiser le formulaire
                    sortieFormRef.current = { article_id: '', quantite: '', date: '', motif: '' };
                    
                } catch (error) {
                    console.error('Erreur lors de l\'ajout de la sortie:', error);
                    alert('Erreur lors de l\'ajout de la sortie: ' + error.message);
                }
            };

            const handleAddCommande = async () => {
                try {
                    console.log('üìã Ajout commande:', commandeFormRef.current);
                    
                    if (!commandeFormRef.current.article_nom || !commandeFormRef.current.quantite) {
                        alert('Veuillez remplir tous les champs obligatoires.');
                        return;
                    }
                    
                    // Trouver l'ID du chantier √† partir du nom
                    const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                    const chantier = chantiers.find(c => c.nom === userChantier);
                    const chantier_id = chantier ? chantier.id : null;
                    
                    if (!chantier_id) {
                        alert('Erreur: Impossible de d√©terminer le chantier.');
                        return;
                    }
                    
                    const commandeData = {
                        chantier_id: chantier_id,
                        article_nom: commandeFormRef.current.article_nom,
                        quantite: parseInt(commandeFormRef.current.quantite),
                        message: commandeFormRef.current.message || null,
                        pointeur_matricule: parseInt(currentUser.matricule)
                    };
                    
                    console.log('üìã Donn√©es commande pr√©par√©es:', commandeData);
                    
                    const { data, error } = await window.supabaseDB.addCommande(commandeData);
                    
                    if (error) {
                        console.error('Erreur lors de l\'ajout de la commande:', error);
                        alert('Erreur lors de l\'ajout de la commande: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Commande ajout√©e avec succ√®s:', data);
                    alert('‚úÖ Commande envoy√©e avec succ√®s !');
                    
                    // Recharger les donn√©es
                    await reloadAllData();
                    
                    // R√©initialiser le formulaire
                    commandeFormRef.current = { article_nom: '', quantite: '', message: '' };
                    
                } catch (error) {
                    console.error('Erreur lors de l\'ajout de la commande:', error);
                    alert('Erreur lors de l\'ajout de la commande: ' + error.message);
                }
            };

            const handleDownloadBonSortie = (sortie) => {
                try {
                    const article = articles.find(a => a.id === sortie.article_id);
                    const chantier = chantiers.find(c => c.id === sortie.chantier_id);
                    
                    const bonSortie = {
                        numero: `BS-${sortie.id}`,
                        date: new Date(sortie.date_sortie).toLocaleDateString('fr-FR'),
                        heure: new Date(sortie.date_sortie).toLocaleTimeString('fr-FR'),
                        chantier: chantier?.nom || 'Chantier inconnu',
                        article: article?.nom || 'Article inconnu',
                        quantite: sortie.quantite,
                        motif: sortie.motif || 'Non sp√©cifi√©',
                        pointeur: currentUser.nom
                    };
                    
                    // Cr√©er le PDF avec jsPDF
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // En-t√™te avec logo
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NE TRAVAUX', 105, 20, { align: 'center' });
                    
                    // Logo placeholder (cercle avec initiales)
                    doc.setFillColor(59, 130, 246); // Bleu
                    doc.circle(20, 20, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.text('NE', 20, 24, { align: 'center' });
                    
                    // Titre du document
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BON DE SORTIE', 105, 40, { align: 'center' });
                    
                    // Informations du bon
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    
                    let yPosition = 60;
                    doc.text(`Num√©ro: ${bonSortie.numero}`, 20, yPosition);
                    doc.text(`Date: ${bonSortie.date}`, 120, yPosition);
                    yPosition += 10;
                    doc.text(`Heure: ${bonSortie.heure}`, 20, yPosition);
                    yPosition += 15;
                    
                    // Informations du chantier et pointeur
                    doc.setFont('helvetica', 'bold');
                    doc.text('INFORMATIONS:', 20, yPosition);
                    yPosition += 10;
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Chantier: ${bonSortie.chantier}`, 20, yPosition);
                    yPosition += 8;
                    doc.text(`Pointeur: ${bonSortie.pointeur}`, 20, yPosition);
                    yPosition += 15;
                    
                    // D√©tails de l'article
                    doc.setFont('helvetica', 'bold');
                    doc.text('ARTICLE SORTI:', 20, yPosition);
                    yPosition += 10;
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Article: ${bonSortie.article}`, 20, yPosition);
                    yPosition += 8;
                    doc.text(`Quantit√©: ${bonSortie.quantite}`, 20, yPosition);
                    yPosition += 8;
                    doc.text(`Motif: ${bonSortie.motif}`, 20, yPosition);
                    yPosition += 20;
                    
                    // Tableau r√©capitulatif
                    doc.setFont('helvetica', 'bold');
                    doc.text('R√âCAPITULATIF:', 20, yPosition);
                    yPosition += 10;
                    
                    const tableData = [
                        ['Article', 'Quantit√©', 'Motif'],
                        [bonSortie.article, bonSortie.quantite.toString(), bonSortie.motif]
                    ];
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [tableData[0]],
                        body: [tableData[1]],
                        theme: 'grid',
                        headStyles: { fillColor: [59, 130, 246] },
                        margin: { left: 20 }
                    });
                    
                    // Signature
                    const finalY = doc.lastAutoTable.finalY + 20;
                    doc.text('Signature du pointeur:', 20, finalY);
                    doc.line(20, finalY + 5, 80, finalY + 5);
                    
                    doc.text('Signature du responsable:', 120, finalY);
                    doc.line(120, finalY + 5, 180, finalY + 5);
                    
                    // Pied de page
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Document g√©n√©r√© automatiquement par NE TRAVAUX - Gestion de Stock', 105, 280, { align: 'center' });
                    
                    // Sauvegarder le PDF
                    doc.save(`bon-sortie-${bonSortie.numero}.pdf`);
                    
                    console.log('üìÑ Bon de sortie PDF g√©n√©r√©:', bonSortie);
                    
                } catch (error) {
                    console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                    alert('Erreur lors de la g√©n√©ration du PDF: ' + error.message);
                }
            };

            const handleUpdateCommandeStatus = async (id, statut) => {
                try {
                    console.log('üìã Mise √† jour statut commande:', { id, statut });
                    
                    const { data, error } = await window.supabaseDB.updateCommandeStatus(id, statut);
                    
                    if (error) {
                        console.error('Erreur lors de la mise √† jour du statut:', error);
                        alert('Erreur lors de la mise √† jour du statut: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Statut commande mis √† jour:', data);
                    alert(`‚úÖ Commande ${statut === 'approuvee' ? 'approuv√©e' : 'rejet√©e'} avec succ√®s !`);
                    
                    // Recharger les donn√©es
                    await reloadAllData();
                    
                } catch (error) {
                    console.error('Erreur lors de la mise √† jour du statut:', error);
                    alert('Erreur lors de la mise √† jour du statut: ' + error.message);
                }
            };

            const handleExportRapport = () => {
                try {
                    console.log('üìÑ G√©n√©ration du rapport PDF...');
                    
                    // Filtrer les donn√©es selon les crit√®res
                    let entreesFiltrees = entrees;
                    let sortiesFiltrees = sorties;
                    let commandesFiltrees = commandes;
                    
                    if (filterChantier) {
                        entreesFiltrees = entrees.filter(e => e.chantier_id === parseInt(filterChantier));
                        sortiesFiltrees = sorties.filter(s => s.chantier_id === parseInt(filterChantier));
                        commandesFiltrees = commandes.filter(c => c.chantier_id === parseInt(filterChantier));
                    }
                    
                    if (filterPointeur) {
                        entreesFiltrees = entreesFiltrees.filter(e => e.pointeur_matricule === parseInt(filterPointeur));
                        sortiesFiltrees = sortiesFiltrees.filter(s => s.pointeur_matricule === parseInt(filterPointeur));
                        commandesFiltrees = commandesFiltrees.filter(c => c.pointeur_matricule === parseInt(filterPointeur));
                    }
                    
                    if (filterDate) {
                        const dateFilter = new Date(filterDate);
                        entreesFiltrees = entreesFiltrees.filter(e => 
                            new Date(e.date_entree).toDateString() === dateFilter.toDateString()
                        );
                        sortiesFiltrees = sortiesFiltrees.filter(s => 
                            new Date(s.date_sortie).toDateString() === dateFilter.toDateString()
                        );
                        commandesFiltrees = commandesFiltrees.filter(c => 
                            new Date(c.created_at).toDateString() === dateFilter.toDateString()
                        );
                    }
                    
                    // Cr√©er le contenu du rapport
                    const rapportContent = `
RAPPORT D'ACTIVIT√â - NE TRAVAUX
Date: ${new Date().toLocaleDateString('fr-FR')}
Heure: ${new Date().toLocaleTimeString('fr-FR')}

${filterChantier ? `Chantier: ${chantiers.find(c => c.id === parseInt(filterChantier))?.nom || 'Inconnu'}` : 'Tous les chantiers'}
${filterPointeur ? `Pointeur: ${users.find(u => u.matricule === parseInt(filterPointeur))?.nom || 'Inconnu'}` : 'Tous les pointeurs'}
${filterDate ? `Date: ${filterDate}` : 'Toutes les dates'}

=== R√âSUM√â ===
Entr√©es: ${entreesFiltrees.length}
Sorties: ${sortiesFiltrees.length}
Commandes: ${commandesFiltrees.length}

=== D√âTAIL DES ENTREES ===
${entreesFiltrees.map(entree => {
    const article = articles.find(a => a.id === entree.article_id);
    const chantier = chantiers.find(c => c.id === entree.chantier_id);
    const pointeur = users.find(u => u.matricule === entree.pointeur_matricule);
    return `- ${article?.nom || 'Article inconnu'} (${entree.quantite}) - ${chantier?.nom || 'Chantier inconnu'} - ${pointeur?.nom || 'Pointeur inconnu'} - ${new Date(entree.date_entree).toLocaleDateString('fr-FR')}`;
}).join('\n')}

=== D√âTAIL DES SORTIES ===
${sortiesFiltrees.map(sortie => {
    const article = articles.find(a => a.id === sortie.article_id);
    const chantier = chantiers.find(c => c.id === sortie.chantier_id);
    const pointeur = users.find(u => u.matricule === sortie.pointeur_matricule);
    return `- ${article?.nom || 'Article inconnu'} (${sortie.quantite}) - ${chantier?.nom || 'Chantier inconnu'} - ${pointeur?.nom || 'Pointeur inconnu'} - ${new Date(sortie.date_sortie).toLocaleDateString('fr-FR')}`;
}).join('\n')}

=== D√âTAIL DES COMMANDES ===
${commandesFiltrees.map(commande => {
    const chantier = chantiers.find(c => c.id === commande.chantier_id);
    const pointeur = users.find(u => u.matricule === commande.pointeur_matricule);
    return `- ${commande.article_nom} (${commande.quantite}) - ${chantier?.nom || 'Chantier inconnu'} - ${pointeur?.nom || 'Pointeur inconnu'} - ${commande.statut} - ${new Date(commande.created_at).toLocaleDateString('fr-FR')}`;
}).join('\n')}

---
G√©n√©r√© automatiquement par NE TRAVAUX - Gestion de Stock
                    `.trim();
                    
                    // Cr√©er et t√©l√©charger le fichier
                    const blob = new Blob([rapportContent], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rapport-ne-travaux-${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    console.log('üìÑ Rapport export√© avec succ√®s');
                    alert('‚úÖ Rapport export√© avec succ√®s !');
                    
                } catch (error) {
                    console.error('Erreur lors de l\'export du rapport:', error);
                    alert('Erreur lors de l\'export du rapport: ' + error.message);
                }
            };

            // Composant Stock
            function Stock() {
                const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                const [activePointeurTab, setActivePointeurTab] = useState('stock');
                
                console.log('üîç Donn√©es utilisateur connect√©:', {
                    currentUser: currentUser,
                    userChantier: userChantier,
                    articles: articles.length,
                    chantiers: chantiers.length
                });
                
                const filteredArticles = currentUser.role === 'admin' 
                    ? articles 
                    : articles.filter(article => {
                        const chantier = chantiers.find(c => c.id === article.chantier_id);
                        const matches = chantier && chantier.nom === userChantier;
                        console.log('üîç Filtrage article:', {
                            article: article.nom,
                            article_chantier_id: article.chantier_id,
                            chantier_nom: chantier?.nom,
                            userChantier: userChantier,
                            matches: matches
                        });
                        return matches;
                    });

                // Grouper les articles par chantier pour l'admin
                const articlesByChantier = currentUser.role === 'admin' ? 
                    chantiers.map(chantier => ({
                        chantier: chantier,
                        articles: articles.filter(article => article.chantier_id === chantier.id)
                    })).filter(group => group.articles.length > 0) : [];

                // Composant pour les pointeurs
                function PointeurInterface() {
                    return (
                        <div className="space-y-6">
                            {/* En-t√™te avec nom du chantier */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800">Mon Chantier</h2>
                                        <p className="text-gray-600 mt-1">{userChantier}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-gray-500">Connect√© en tant que</p>
                                        <p className="font-semibold text-gray-800">{currentUser.nom}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Onglets pour les pointeurs */}
                            <div className="bg-white rounded-lg shadow-md">
                                <div className="border-b border-gray-200">
                                    <nav className="flex space-x-8 px-6 mobile-tab-full mobile-stack md:flex-row">
                                        <button
                                            onClick={() => setActivePointeurTab('stock')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activePointeurTab === 'stock'
                                                    ? 'border-blue-500 text-blue-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            üì¶ Mon Stock
                                        </button>
                                        <button
                                            onClick={() => setActivePointeurTab('entrees')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activePointeurTab === 'entrees'
                                                    ? 'border-green-500 text-green-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            üì• Entr√©es
                                        </button>
                                        <button
                                            onClick={() => setActivePointeurTab('sorties')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activePointeurTab === 'sorties'
                                                    ? 'border-red-500 text-red-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            üì§ Sorties
                                        </button>
                                        <button
                                            onClick={() => setActivePointeurTab('commandes')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activePointeurTab === 'commandes'
                                                    ? 'border-purple-500 text-purple-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            üìã Commandes
                                        </button>
                                    </nav>
                                </div>

                                <div className="p-6">
                                    {activePointeurTab === 'stock' && (
                                        <div className="space-y-4">
                                            <h3 className="text-lg font-semibold text-gray-800">Stock de mon chantier</h3>
                                            {filteredArticles.length > 0 ? (
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    {filteredArticles.map(article => (
                                                        <div key={article.id} className="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center space-x-3">
                                                                    <span className="text-xl">{article.icone}</span>
                                                                    <div>
                                                                        <h4 className="font-semibold text-gray-800">{article.nom}</h4>
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-xl font-bold text-blue-600">{article.quantite}</div>
                                                                    <div className="text-xs text-gray-500">en stock</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8">
                                                    <div className="text-4xl mb-2">üì¶</div>
                                                    <p className="text-gray-500">Aucun article en stock pour ce chantier</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activePointeurTab === 'entrees' && (
                                        <div className="space-y-6">
                                            <h3 className="text-lg font-semibold text-gray-800">Saisir une entr√©e</h3>
                                            
                                            {/* Formulaire d'entr√©e */}
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-green-800 mb-4">üì• Nouvelle entr√©e</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mobile-form-stack">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Article</label>
                                                        <select
                                                            defaultValue=""
                                                            onBlur={(e) => entreeFormRef.current.article_id = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                                        >
                                                            <option value="">S√©lectionner un article</option>
                                                            {articles.filter(article => {
                                                                const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                                const chantier = chantiers.find(c => c.nom === userChantier);
                                                                return chantier && article.chantier_id === chantier.id;
                                                            }).map(article => (
                                                                <option key={article.id} value={article.id}>
                                                                    {article.icone} {article.nom}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantit√©</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            defaultValue=""
                                                            onBlur={(e) => entreeFormRef.current.quantite = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                                            placeholder="Quantit√© re√ßue"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Date d'entr√©e</label>
                                                        <input
                                                            type="datetime-local"
                                                            defaultValue={new Date().toISOString().slice(0, 16)}
                                                            onBlur={(e) => entreeFormRef.current.date = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Bon d'entr√©e (Image)</label>
                                                        <input
                                                            type="file"
                                                            accept="image/*"
                                                            onChange={(e) => {
                                                                const file = e.target.files[0];
                                                                if (file) {
                                                                    entreeFormRef.current.bon_entree_file = file;
                                                                    console.log('üì∏ Fichier s√©lectionn√©:', file.name);
                                                                }
                                                            }}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                                        />
                                                        <p className="text-xs text-gray-500 mt-1">
                                                            Formats accept√©s: JPG, PNG, GIF (max 5MB)
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="mt-4">
                                                    <button
                                                        onClick={handleAddEntree}
                                                        className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                                                    >
                                                        üì• Enregistrer l'entr√©e
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Historique des entr√©es */}
                                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-gray-800 mb-4">üìã Historique des entr√©es</h4>
                                                {entrees.filter(entree => {
                                                    const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                    const chantier = chantiers.find(c => c.nom === userChantier);
                                                    return chantier && entree.chantier_id === chantier.id;
                                                }).length > 0 ? (
                                                    <div className="space-y-3">
                                                        {entrees.filter(entree => {
                                                            const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                            const chantier = chantiers.find(c => c.nom === userChantier);
                                                            return chantier && entree.chantier_id === chantier.id;
                                                        }).map(entree => {
                                                            const article = articles.find(a => a.id === entree.article_id);
                                                            return (
                                                                <div key={entree.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                                    <div className="flex items-center space-x-3">
                                                                        <span className="text-lg">{article?.icone || 'üì¶'}</span>
                                                                        <div>
                                                                            <p className="font-medium text-gray-800">{article?.nom || 'Article inconnu'}</p>
                                                                            <p className="text-sm text-gray-500">
                                                                                {new Date(entree.date_entree).toLocaleDateString('fr-FR')} √† {new Date(entree.date_entree).toLocaleTimeString('fr-FR')}
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-lg font-bold text-green-600">+{entree.quantite}</div>
                                                                        {entree.bon_entree_url && (
                                                                            <a href={entree.bon_entree_url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline">
                                                                                Voir bon d'entr√©e
                                                                            </a>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-500 text-center py-4">Aucune entr√©e enregistr√©e</p>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {activePointeurTab === 'sorties' && (
                                        <div className="space-y-6">
                                            <h3 className="text-lg font-semibold text-gray-800">Saisir une sortie</h3>
                                            
                                            {/* Formulaire de sortie */}
                                            <div className="bg-red-50 border border-red-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-red-800 mb-4">üì§ Nouvelle sortie</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mobile-form-stack">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Article</label>
                                                        <select
                                                            defaultValue=""
                                                            onBlur={(e) => sortieFormRef.current.article_id = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                                        >
                                                            <option value="">S√©lectionner un article</option>
                                                            {articles.filter(article => {
                                                                const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                                const chantier = chantiers.find(c => c.nom === userChantier);
                                                                return chantier && article.chantier_id === chantier.id && article.quantite > 0;
                                                            }).map(article => (
                                                                <option key={article.id} value={article.id}>
                                                                    {article.icone} {article.nom} (Stock: {article.quantite})
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantit√©</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            defaultValue=""
                                                            onBlur={(e) => sortieFormRef.current.quantite = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                                            placeholder="Quantit√© sortie"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Date de sortie</label>
                                                        <input
                                                            type="datetime-local"
                                                            defaultValue={new Date().toISOString().slice(0, 16)}
                                                            onBlur={(e) => sortieFormRef.current.date = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Motif de sortie</label>
                                                        <input
                                                            type="text"
                                                            defaultValue=""
                                                            onBlur={(e) => sortieFormRef.current.motif = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                                            placeholder="Ex: Utilisation chantier, Transfert..."
                                                        />
                                                    </div>
                                                </div>
                                                <div className="mt-4">
                                                    <button
                                                        onClick={handleAddSortie}
                                                        className="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                                                    >
                                                        üì§ Enregistrer la sortie
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Historique des sorties */}
                                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-gray-800 mb-4">üìã Historique des sorties</h4>
                                                {sorties.filter(sortie => {
                                                    const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                    const chantier = chantiers.find(c => c.nom === userChantier);
                                                    return chantier && sortie.chantier_id === chantier.id;
                                                }).length > 0 ? (
                                                    <div className="space-y-3">
                                                        {sorties.filter(sortie => {
                                                            const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                            const chantier = chantiers.find(c => c.nom === userChantier);
                                                            return chantier && sortie.chantier_id === chantier.id;
                                                        }).map(sortie => {
                                                            const article = articles.find(a => a.id === sortie.article_id);
                                                            return (
                                                                <div key={sortie.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                                    <div className="flex items-center space-x-3">
                                                                        <span className="text-lg">{article?.icone || 'üì¶'}</span>
                                                                        <div>
                                                                            <p className="font-medium text-gray-800">{article?.nom || 'Article inconnu'}</p>
                                                                            <p className="text-sm text-gray-500">
                                                                                {new Date(sortie.date_sortie).toLocaleDateString('fr-FR')} √† {new Date(sortie.date_sortie).toLocaleTimeString('fr-FR')}
                                                                            </p>
                                                                            {sortie.motif && (
                                                                                <p className="text-xs text-gray-400">Motif: {sortie.motif}</p>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-lg font-bold text-red-600">-{sortie.quantite}</div>
                                                                        <button
                                                                            onClick={() => handleDownloadBonSortie(sortie)}
                                                                            className="text-xs text-blue-600 hover:underline"
                                                                        >
                                                                            üìÑ T√©l√©charger bon de sortie
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-500 text-center py-4">Aucune sortie enregistr√©e</p>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {activePointeurTab === 'commandes' && (
                                        <div className="space-y-6">
                                            <h3 className="text-lg font-semibold text-gray-800">Passer une commande</h3>
                                            
                                            {/* Formulaire de commande */}
                                            <div className="bg-purple-50 border border-purple-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-purple-800 mb-4">üìã Nouvelle commande</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mobile-form-stack">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Nom de l'article</label>
                                                        <input
                                                            type="text"
                                                            defaultValue=""
                                                            onBlur={(e) => commandeFormRef.current.article_nom = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                            placeholder="Ex: Ciment, Fer √† b√©ton..."
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantit√© demand√©e</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            defaultValue=""
                                                            onBlur={(e) => commandeFormRef.current.quantite = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                            placeholder="Quantit√©"
                                                        />
                                                    </div>
                                                    <div className="md:col-span-2">
                                                        <label className="block text-sm font-medium text-gray-700 mb-2">Message (optionnel)</label>
                                                        <textarea
                                                            defaultValue=""
                                                            onBlur={(e) => commandeFormRef.current.message = e.target.value}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                            rows="3"
                                                            placeholder="Pr√©cisions sur la commande, urgence, etc."
                                                        />
                                                    </div>
                                                </div>
                                                <div className="mt-4">
                                                    <button
                                                        onClick={handleAddCommande}
                                                        className="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    >
                                                        üìã Envoyer la commande
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Historique des commandes */}
                                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                                                <h4 className="font-semibold text-gray-800 mb-4">üìã Mes commandes</h4>
                                                {commandes.filter(commande => {
                                                    const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                    const chantier = chantiers.find(c => c.nom === userChantier);
                                                    return chantier && commande.chantier_id === chantier.id;
                                                }).length > 0 ? (
                                                    <div className="space-y-3">
                                                        {commandes.filter(commande => {
                                                            const userChantier = currentUser.role === 'admin' ? null : currentUser.chantier;
                                                            const chantier = chantiers.find(c => c.nom === userChantier);
                                                            return chantier && commande.chantier_id === chantier.id;
                                                        }).map(commande => (
                                                            <div key={commande.id} className="p-4 bg-gray-50 rounded-lg border-l-4 border-purple-500">
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <div className="flex items-center space-x-3">
                                                                        <span className="text-lg">üì¶</span>
                                                                        <div>
                                                                            <p className="font-medium text-gray-800">{commande.article_nom}</p>
                                                                            <p className="text-sm text-gray-500">
                                                                                {new Date(commande.created_at).toLocaleDateString('fr-FR')} √† {new Date(commande.created_at).toLocaleTimeString('fr-FR')}
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-lg font-bold text-purple-600">{commande.quantite}</div>
                                                                        <span className={`text-xs px-2 py-1 rounded-full ${
                                                                            commande.statut === 'en_attente' ? 'bg-yellow-100 text-yellow-800' :
                                                                            commande.statut === 'approuvee' ? 'bg-green-100 text-green-800' :
                                                                            'bg-red-100 text-red-800'
                                                                        }`}>
                                                                            {commande.statut === 'en_attente' ? '‚è≥ En attente' :
                                                                             commande.statut === 'approuvee' ? '‚úÖ Approuv√©e' :
                                                                             '‚ùå Rejet√©e'}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                {commande.message && (
                                                                    <div className="mt-2 p-2 bg-white rounded border">
                                                                        <p className="text-sm text-gray-600">{commande.message}</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-500 text-center py-4">Aucune commande enregistr√©e</p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="space-y-6">
                        {currentUser.role === 'admin' ? (
                            // Vue Admin
                            <>
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-gray-800">Stock Global</h2>
                                    <button
                                        onClick={() => setActiveTab('admin')}
                                        className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
                                    >
                                        Administration
                                    </button>
                                </div>

                                {loading && (
                                    <div className="text-center py-8">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                                        <p className="mt-4 text-gray-600">Chargement des donn√©es...</p>
                                    </div>
                                )}

                                {!loading && (
                                    <div className="space-y-8">
                                        {articlesByChantier.length > 0 ? (
                                            articlesByChantier.map(group => (
                                                <div key={group.chantier.id} className="bg-white rounded-lg shadow-md p-6">
                                                    <div className="flex items-center mb-4">
                                                        <span className="text-2xl mr-3">üèóÔ∏è</span>
                                                        <h3 className="text-xl font-semibold text-gray-800">{group.chantier.nom}</h3>
                                                        <span className="ml-2 text-sm text-gray-500">({group.articles.length} articles)</span>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        {group.articles.map(article => (
                                                            <div key={article.id} className="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                                <div className="flex items-center justify-between">
                                                                    <div className="flex items-center space-x-3">
                                                                        <span className="text-xl">{article.icone}</span>
                                                                        <div>
                                                                            <h4 className="font-semibold text-gray-800">{article.nom}</h4>
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-xl font-bold text-blue-600">{article.quantite}</div>
                                                                        <div className="text-xs text-gray-500">en stock</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <div className="text-center py-12">
                                                <div className="text-6xl mb-4">üì¶</div>
                                                <h3 className="text-xl font-semibold text-gray-600 mb-2">Aucun article en stock</h3>
                                                <p className="text-gray-500">Les articles appara√Ætront ici une fois ajout√©s</p>
                                            </div>
                                        )}
                                        
                                        {chantiers.length === 0 && (
                                            <div className="text-center py-8 bg-yellow-50 rounded-lg border border-yellow-200">
                                                <div className="text-4xl mb-2">üèóÔ∏è</div>
                                                <h3 className="text-lg font-semibold text-yellow-800 mb-2">Aucun chantier cr√©√©</h3>
                                                <p className="text-yellow-700">Cr√©ez d'abord des chantiers pour organiser vos articles</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        ) : (
                            // Vue Pointeur
                            <PointeurInterface />
                        )}
                    </div>
                );
            }

            // Composant Admin
            function Admin({ newChantier, setNewChantier, newArticle, setNewArticle }) {
                return (
                    <div className="space-y-8">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">Administration</h2>
                            <button
                                onClick={() => setActiveTab('stock')}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                            >
                                Retour au Stock
                            </button>
                        </div>

                        {/* Gestion des chantiers */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-xl font-semibold mb-4">Gestion des Chantiers</h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <input
                                    type="text"
                                    placeholder="Nom du chantier"
                                    defaultValue=""
                                    onBlur={(e) => chantierFormRef.current.nom = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                />
                                <input
                                    type="text"
                                    placeholder="Description"
                                    defaultValue=""
                                    onBlur={(e) => chantierFormRef.current.description = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                />
                            </div>
                            
                            <button
                                onClick={handleAddChantier}
                                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
                            >
                                Ajouter un chantier
                            </button>

                            {loading && (
                                <div className="mt-6 text-center py-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                                    <p className="mt-2 text-gray-600">Chargement...</p>
                                </div>
                            )}

                            {!loading && (
                                <div className="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {chantiers.map(chantier => (
                                        <div key={chantier.id} className="border rounded-lg p-4">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h4 className="font-semibold">{chantier.nom}</h4>
                                                    <p className="text-sm text-gray-600">{chantier.description}</p>
                                                </div>
                                                <button
                                                    onClick={() => handleDeleteChantier(chantier.id)}
                                                    className="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600"
                                                >
                                                    Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Gestion des articles */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-xl font-semibold mb-4">Gestion des Articles</h3>
                            
                            <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-blue-800 text-sm">
                                    <strong>üí° Note :</strong> Vous devez d'abord cr√©er un chantier, puis le s√©lectionner avant d'ajouter un article.
                                </p>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <input
                                    type="text"
                                    placeholder="Nom de l'article"
                                    defaultValue=""
                                    onBlur={(e) => articleFormRef.current.nom = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                    type="number"
                                    placeholder="Quantit√© initiale"
                                    defaultValue=""
                                    onBlur={(e) => articleFormRef.current.quantite = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <select
                                    defaultValue=""
                                    onChange={(e) => articleFormRef.current.chantier_id = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">S√©lectionner un chantier</option>
                                    {chantiers.map(chantier => (
                                        <option key={chantier.id} value={chantier.id}>{chantier.nom}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <button
                                onClick={handleAddArticle}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                disabled={chantiers.length === 0}
                            >
                                {chantiers.length === 0 ? 'Cr√©ez d\'abord un chantier' : 'Ajouter un article'}
                            </button>

                            {loading && (
                                <div className="mt-6 text-center py-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                    <p className="mt-2 text-gray-600">Chargement...</p>
                                </div>
                            )}

                            {!loading && (
                                <div className="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {articles.map(article => {
                                        const chantier = chantiers.find(c => c.id === article.chantier_id);
                                        return (
                                            <div key={article.id} className="border rounded-lg p-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h4 className="font-semibold">{article.nom}</h4>
                                                        <p className="text-sm text-gray-600">Quantit√©: {article.quantite}</p>
                                                        {chantier && <p className="text-sm text-gray-500">{chantier.nom}</p>}
                                                    </div>
                                                    <button
                                                        onClick={() => handleDeleteArticle(article.id)}
                                                        className="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600"
                                                    >
                                                        Supprimer
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {/* Gestion des utilisateurs */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-xl font-semibold mb-4">Gestion des Utilisateurs</h3>
                            
                            <div className="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                <p className="text-purple-800 text-sm">
                                    <strong>üí° Note :</strong> Cr√©ez des comptes pointeurs et affectez-les aux chantiers.
                                </p>
                                <p className="text-purple-700 text-xs mt-1">
                                    <strong>üí° Conseil :</strong> Utilisez un matricule unique (ex: 101, 102, 103...)
                                </p>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <input
                                    type="text"
                                    placeholder="Nom complet"
                                    defaultValue=""
                                    onBlur={(e) => userFormRef.current.nom = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                                <input
                                    type="number"
                                    placeholder="Matricule"
                                    defaultValue=""
                                    onBlur={(e) => userFormRef.current.matricule = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                                <input
                                    type="password"
                                    placeholder="Mot de passe"
                                    defaultValue=""
                                    onBlur={(e) => userFormRef.current.password = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                                <select
                                    defaultValue=""
                                    onChange={(e) => userFormRef.current.chantier_id = e.target.value}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                >
                                    <option value="">S√©lectionner un chantier</option>
                                    {chantiers.map(chantier => (
                                        <option key={chantier.id} value={chantier.id}>{chantier.nom}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <button
                                onClick={handleAddUser}
                                className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
                                disabled={chantiers.length === 0}
                            >
                                {chantiers.length === 0 ? 'Cr√©ez d\'abord un chantier' : 'Cr√©er un pointeur'}
                            </button>

                            {loading && (
                                <div className="mt-6 text-center py-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"></div>
                                    <p className="mt-2 text-gray-600">Chargement...</p>
                                </div>
                            )}

                            {!loading && (
                                <div className="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {users.filter(user => user.role === 'pointeur').map(user => {
                                        const chantier = chantiers.find(c => c.id === user.chantier_id);
                                        return (
                                            <div key={user.id} className="border rounded-lg p-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h4 className="font-semibold">{user.nom}</h4>
                                                        <p className="text-sm text-gray-600">Matricule: {user.matricule}</p>
                                                        <p className="text-sm text-gray-500">R√¥le: Pointeur</p>
                                                        {chantier && <p className="text-sm text-purple-600">{chantier.nom}</p>}
                                                    </div>
                                                    <button
                                                        onClick={() => handleDeleteUser(user.id)}
                                                        className="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600"
                                                    >
                                                        Supprimer
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {/* Historique et Rapports */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-xl font-semibold mb-4">üìä Historique et Rapports</h3>
                            
                            <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-blue-800 text-sm">
                                    <strong>üí° Note :</strong> Consultez l'historique des op√©rations et g√©n√©rez des rapports.
                                </p>
                            </div>

                            {/* Filtres */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <select
                                    defaultValue=""
                                    onChange={(e) => setFilterChantier(e.target.value)}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">Tous les chantiers</option>
                                    {chantiers.map(chantier => (
                                        <option key={chantier.id} value={chantier.id}>{chantier.nom}</option>
                                    ))}
                                </select>
                                <select
                                    defaultValue=""
                                    onChange={(e) => setFilterPointeur(e.target.value)}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">Tous les pointeurs</option>
                                    {users.filter(u => u.role === 'pointeur').map(user => (
                                        <option key={user.matricule} value={user.matricule}>{user.nom}</option>
                                    ))}
                                </select>
                                <input
                                    type="date"
                                    onChange={(e) => setFilterDate(e.target.value)}
                                    className="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button
                                    onClick={handleExportRapport}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                >
                                    üìÑ Exporter PDF
                                </button>
                            </div>

                            {/* Statistiques */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-green-600">{entrees.length}</div>
                                    <div className="text-sm text-green-800">Entr√©es</div>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-red-600">{sorties.length}</div>
                                    <div className="text-sm text-red-800">Sorties</div>
                                </div>
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-purple-600">{commandes.filter(c => c.statut === 'en_attente').length}</div>
                                    <div className="text-sm text-purple-800">Commandes en attente</div>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-blue-600">{articles.length}</div>
                                    <div className="text-sm text-blue-800">Articles</div>
                                </div>
                            </div>
                        </div>

                        {/* Gestion des commandes */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-xl font-semibold mb-4">üìã Gestion des Commandes</h3>
                            
                            <div className="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                                <p className="text-orange-800 text-sm">
                                    <strong>üí° Note :</strong> Traitez les commandes des pointeurs et r√©pondez √† leurs messages.
                                </p>
                            </div>

                            {loading && (
                                <div className="text-center py-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mx-auto"></div>
                                    <p className="mt-2 text-gray-600">Chargement des commandes...</p>
                                </div>
                            )}

                            {!loading && (
                                <div className="space-y-4">
                                    {commandes.length > 0 ? (
                                        commandes.map(commande => {
                                            const pointeur = users.find(u => u.matricule === commande.pointeur_matricule);
                                            const chantier = chantiers.find(c => c.id === commande.chantier_id);
                                            return (
                                                <div key={commande.id} className="border rounded-lg p-4 bg-gray-50">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h4 className="font-semibold text-lg">{commande.article_nom}</h4>
                                                            <p className="text-sm text-gray-600">
                                                                Quantit√©: <span className="font-semibold">{commande.quantite}</span>
                                                            </p>
                                                            <p className="text-sm text-gray-500">
                                                                Pointeur: <span className="font-semibold">{pointeur?.nom || 'Inconnu'}</span>
                                                            </p>
                                                            <p className="text-sm text-gray-500">
                                                                Chantier: <span className="font-semibold">{chantier?.nom || 'Inconnu'}</span>
                                                            </p>
                                                            <p className="text-xs text-gray-400">
                                                                {new Date(commande.created_at).toLocaleDateString('fr-FR')} √† {new Date(commande.created_at).toLocaleTimeString('fr-FR')}
                                                            </p>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className={`text-xs px-2 py-1 rounded-full ${
                                                                commande.statut === 'en_attente' ? 'bg-yellow-100 text-yellow-800' :
                                                                commande.statut === 'approuvee' ? 'bg-green-100 text-green-800' :
                                                                'bg-red-100 text-red-800'
                                                            }`}>
                                                                {commande.statut === 'en_attente' ? '‚è≥ En attente' :
                                                                 commande.statut === 'approuvee' ? '‚úÖ Approuv√©e' :
                                                                 '‚ùå Rejet√©e'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    {commande.message && (
                                                        <div className="mb-3 p-3 bg-white rounded border">
                                                            <p className="text-sm text-gray-700">{commande.message}</p>
                                                        </div>
                                                    )}
                                                    
                                                    {commande.statut === 'en_attente' && (
                                                        <div className="flex space-x-2">
                                                            <button
                                                                onClick={() => handleUpdateCommandeStatus(commande.id, 'approuvee')}
                                                                className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                                                            >
                                                                ‚úÖ Approuver
                                                            </button>
                                                            <button
                                                                onClick={() => handleUpdateCommandeStatus(commande.id, 'rejetee')}
                                                                className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
                                                            >
                                                                ‚ùå Rejeter
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })
                                    ) : (
                                        <div className="text-center py-8">
                                            <div className="text-4xl mb-2">üìã</div>
                                            <p className="text-gray-500">Aucune commande en attente</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Interface principale
            if (!currentUser) {
                return <Login onLogin={handleLogin} />;
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div className="flex items-center space-x-4">
                                    <img src="./logo.jpg.jpg" alt="Logo" className="w-10 h-10 rounded-full" />
                                    <div>
                                        <h1 className="text-xl font-bold text-gray-900">NE Travaux</h1>
                                        <p className="text-sm text-gray-600">Gestion de Stock</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <span className="text-sm text-gray-600">
                                        Connect√© en tant que <span className="font-semibold">{currentUser.nom}</span>
                                    </span>
                                    <button
                                        onClick={handleLogout}
                                        className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                                    >
                                        D√©connexion
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {activeTab === 'stock' ? <Stock /> : <Admin 
                            newChantier={chantierFormRef.current} 
                            setNewChantier={() => {}}
                            newArticle={articleFormRef.current}
                            setNewArticle={() => {}}
                        />}
                    </main>
                </div>
            );
        }

        // Rendu de l'application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
