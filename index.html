<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NE Travaux - Gestion de Stock</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Rendre createClient disponible globalement
        window.createClient = window.supabase.createClient;
    </script>
    <script src="supabase-client.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .pwa-install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #3B82F6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" class="pwa-install-prompt">
        <button id="install-btn" class="mr-2 px-3 py-1 bg-white text-blue-600 rounded">Installer</button>
        <button id="dismiss-btn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded">Fermer</button>
    </div>
    
    <!-- App Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;

                 // Donn√©es initiales
         const initialUsers = [
           { matricule: '100', nom: 'Said El Khalfaoui', role: 'admin', chantier: 'Admin' },
           { matricule: '200', nom: 'Pointeur 1', role: 'pointeur', chantier: 'Chantier A' },
           { matricule: '300', nom: 'Pointeur 2', role: 'pointeur', chantier: 'Chantier B' },
           { matricule: '400', nom: 'Pointeur 3', role: 'pointeur', chantier: 'Chantier C' },
           { matricule: '500', nom: 'Pointeur 4', role: 'pointeur', chantier: 'Chantier D' },
           { matricule: '600', nom: 'Pointeur 5', role: 'pointeur', chantier: 'Chantier E' }
         ];

         const initialChantiers = [
           { id: 1, nom: 'Chantier A', description: 'Site principal', statut: 'actif', pointeurs: ['200'] },
           { id: 2, nom: 'Chantier B', description: 'Extension nord', statut: 'actif', pointeurs: ['300'] },
           { id: 3, nom: 'Chantier C', description: 'Zone sud', statut: 'actif', pointeurs: ['400'] },
           { id: 4, nom: 'Chantier D', description: 'R√©habilitation', statut: 'actif', pointeurs: ['500'] },
           { id: 5, nom: 'Chantier E', description: 'Nouveau projet', statut: 'actif', pointeurs: ['600'] }
         ];

                 const initialArticles = [
           // Chantier A
           { id: 1, nom: 'Ciment', icone: 'üõ†Ô∏è', quantite: 50, entree: 0, sortie: 0, chantierId: 1 },
           { id: 2, nom: 'Sable', icone: 'üèñÔ∏è', quantite: 200, entree: 0, sortie: 0, chantierId: 1 },
           { id: 3, nom: 'Briques', icone: 'üß±', quantite: 300, entree: 0, sortie: 0, chantierId: 1 },
           
           // Chantier B
           { id: 4, nom: 'Ciment', icone: 'üõ†Ô∏è', quantite: 30, entree: 0, sortie: 0, chantierId: 2 },
           { id: 5, nom: 'Sable', icone: 'üèñÔ∏è', quantite: 150, entree: 0, sortie: 0, chantierId: 2 },
           { id: 6, nom: 'Briques', icone: 'üß±', quantite: 200, entree: 0, sortie: 0, chantierId: 2 },
           
           // Chantier C
           { id: 7, nom: 'Ciment', icone: 'üõ†Ô∏è', quantite: 40, entree: 0, sortie: 0, chantierId: 3 },
           { id: 8, nom: 'Sable', icone: 'üèñÔ∏è', quantite: 180, entree: 0, sortie: 0, chantierId: 3 },
           { id: 9, nom: 'Briques', icone: 'üß±', quantite: 250, entree: 0, sortie: 0, chantierId: 3 },
           
           // Chantier D
           { id: 10, nom: 'Ciment', icone: 'üõ†Ô∏è', quantite: 25, entree: 0, sortie: 0, chantierId: 4 },
           { id: 11, nom: 'Sable', icone: 'üèñÔ∏è', quantite: 120, entree: 0, sortie: 0, chantierId: 4 },
           { id: 12, nom: 'Briques', icone: 'üß±', quantite: 180, entree: 0, sortie: 0, chantierId: 4 },
           
           // Chantier E
           { id: 13, nom: 'Ciment', icone: 'üõ†Ô∏è', quantite: 35, entree: 0, sortie: 0, chantierId: 5 },
           { id: 14, nom: 'Sable', icone: 'üèñÔ∏è', quantite: 160, entree: 0, sortie: 0, chantierId: 5 },
           { id: 15, nom: 'Briques', icone: 'üß±', quantite: 220, entree: 0, sortie: 0, chantierId: 5 }
         ];

         // Donn√©es initiales pour l'historique des mouvements
         const initialHistorique = [
           {
             id: 1,
             date: '2024-01-15T10:30:00',
             type: 'entree',
             articleId: 1,
             quantite: 50,
             userId: '200',
             chantierId: 1,
             notes: 'Livraison initiale',
             uploadedFiles: ['bon_entree_1.pdf']
           },
           {
             id: 2,
             date: '2024-01-15T14:15:00',
             type: 'sortie',
             articleId: 1,
             quantite: 20,
             userId: '200',
             chantierId: 1,
             notes: 'Utilisation chantier',
             uploadedFiles: []
           },
           {
             id: 3,
             date: '2024-01-16T09:00:00',
             type: 'entree',
             articleId: 4,
             quantite: 30,
             userId: '300',
             chantierId: 2,
             notes: 'R√©approvisionnement',
             uploadedFiles: ['bon_entree_2.jpg']
           }
         ];

        // Composant de connexion
        function Login({ onLogin, users }) {
          const [matricule, setMatricule] = useState('');
          const [password, setPassword] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (matricule.trim() && password.trim()) {
              onLogin(matricule, password);
            }
          };

          return (
            <div className="min-h-screen bg-cover bg-center bg-no-repeat flex items-center justify-center p-4 relative overflow-hidden" style={{backgroundImage: 'url("./background.jpg.jpg")'}}>
              {/* Overlay sombre pour am√©liorer la lisibilit√© */}
              <div className="absolute inset-0 bg-black/50"></div>
              
                             <div className="bg-white/20 backdrop-blur-sm rounded-2xl shadow-2xl p-8 w-full max-w-md relative z-10 border-2 border-white/50">
                <div className="text-center mb-8">
                                     <div className="mb-4">
                     <div className="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                       <img src="./logo.jpg.jpg" alt="Logo" className="w-16 h-16 object-contain rounded-full" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                       <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl" style={{display: 'none'}}>NEK</div>
                     </div>
                   </div>
                   <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">NAIT EL KHALFAOUI TRAVAUX</h1>
                </div>
                
                <form onSubmit={handleSubmit} className="space-y-6">
                  <div>
                                         <label htmlFor="matricule" className="block text-sm font-semibold text-white mb-2">
                       Matricule
                     </label>
                                         <input
                       type="text"
                       id="matricule"
                       value={matricule}
                       onChange={(e) => setMatricule(e.target.value)}
                       placeholder="Entrez votre matricule"
                       className="w-full px-4 py-3 border border-white/50 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white/30 backdrop-blur-sm text-white placeholder-white/70"
                       required
                     />
                  </div>
                  
                  <div>
                                         <label htmlFor="password" className="block text-sm font-semibold text-white mb-2">
                       Mot de passe
                     </label>
                                         <input
                       type="password"
                       id="password"
                       value={password}
                       onChange={(e) => setPassword(e.target.value)}
                       placeholder="Entrez votre mot de passe"
                       className="w-full px-4 py-3 border border-white/50 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white/30 backdrop-blur-sm text-white placeholder-white/70"
                       required
                     />
                  </div>
                  
                  <button
                    type="submit"
                    className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 shadow-lg"
                  >
                    Se connecter
                  </button>
                </form>

                                 <div className="mt-6 text-center">
                   <p className="text-sm text-white/80">
                     Acc√®s s√©curis√© au syst√®me de gestion
                   </p>
                 </div>
              </div>
            </div>
          );
        }

                 // Composant Stock
         function Stock({ articles, onUpdateArticle, onAddCommande, currentUser, isAdmin, chantiers }) {
           const [commandeQuantite, setCommandeQuantite] = useState({});
           const [commandeNote, setCommandeNote] = useState({});
           const [uploadedFiles, setUploadedFiles] = useState({});
          const [pendingEntrees, setPendingEntrees] = useState({});
          const [pendingSorties, setPendingSorties] = useState({});
           
           // Filtrer les articles selon le r√¥le de l'utilisateur
           const getArticlesForUser = () => {
             if (isAdmin) {
               // Admin voit tous les articles group√©s par chantier
               return chantiers.map(chantier => ({
                 ...chantier,
                 articles: articles.filter(article => article.chantierId === chantier.id)
               }));
             } else {
               // Pointeur voit uniquement les articles de son chantier
               const userChantier = chantiers.find(c => c.nom === currentUser.chantier);
               if (userChantier) {
                 return articles.filter(article => article.chantierId === userChantier.id);
               }
               return [];
             }
           };

          const handleStockUpdate = (articleId, type, value) => {
            if (type === 'entree') {
              setPendingEntrees({
                ...pendingEntrees,
                [articleId]: parseInt(value || 0)
              });
            } else if (type === 'sortie') {
              setPendingSorties({
                ...pendingSorties,
                [articleId]: parseInt(value || 0)
              });
            }
          };

          const handleValidateStock = (articleId, type) => {
            const article = articles.find(a => a.id === articleId);
            if (!article) return;
            
            let value = 0;
            if (type === 'entree') {
              value = pendingEntrees[articleId] || 0;
              if (value > 0) {
                const newQuantite = article.quantite + value;
                onUpdateArticle(articleId, { 
                  quantite: Math.max(0, newQuantite),
                  entree: value
                });
                setPendingEntrees({
                  ...pendingEntrees,
                  [articleId]: 0
                });
                alert(`Entr√©e de ${value} unit√©s valid√©e !`);
              } else {
                alert('Veuillez entrer une quantit√© valide.');
              }
            } else if (type === 'sortie') {
              value = pendingSorties[articleId] || 0;
              if (value > 0) {
                const newQuantite = article.quantite - value;
                if (newQuantite >= 0) {
                  onUpdateArticle(articleId, { 
                    quantite: Math.max(0, newQuantite),
                    sortie: value
                  });
                  setPendingSorties({
                    ...pendingSorties,
                    [articleId]: 0
                  });
                  alert(`Sortie de ${value} unit√©s valid√©e !`);
                  
                  // G√©n√©rer automatiquement le bon de livraison apr√®s une sortie
                  generateDeliveryNote(articleId);
                } else {
                  alert('Stock insuffisant pour cette sortie.');
                }
              } else {
                alert('Veuillez entrer une quantit√© valide.');
              }
            }
          };

          const handleCommande = (articleId) => {
            const quantite = commandeQuantite[articleId];
            const note = commandeNote[articleId] || '';
            if (quantite && quantite > 0) {
              onAddCommande(articleId, quantite, note);
              setCommandeQuantite({ ...commandeQuantite, [articleId]: '' });
              setCommandeNote({ ...commandeNote, [articleId]: '' });
              alert('Commande ajout√©e avec succ√®s !');
            } else {
              alert('Veuillez entrer une quantit√© valide.');
            }
          };

          const handleFileUpload = (articleId, event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // V√©rifier chaque fichier
            for (const file of files) {
              // V√©rifier le type de fichier
              const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
              if (!allowedTypes.includes(file.type)) {
                alert(`Le fichier "${file.name}" n'est pas autoris√©. Veuillez s√©lectionner des fichiers image (JPG, PNG) ou PDF.`);
                return;
              }
              
              // V√©rifier la taille (max 5MB)
              if (file.size > 5 * 1024 * 1024) {
                alert(`Le fichier "${file.name}" est trop volumineux. Taille maximum : 5MB.`);
                return;
              }
            }

            // Cr√©er les URLs pour pr√©visualisation
            const newFiles = files.map(file => ({
              name: file.name,
              size: file.size,
              type: file.type,
              url: URL.createObjectURL(file),
              date: new Date().toLocaleString('fr-FR')
            }));
            
            // Ajouter aux fichiers existants ou cr√©er un nouveau tableau
            const existingFiles = uploadedFiles[articleId] || [];
            const updatedFiles = Array.isArray(existingFiles) 
              ? [...existingFiles, ...newFiles]
              : [existingFiles, ...newFiles];
            
            setUploadedFiles({
              ...uploadedFiles,
              [articleId]: updatedFiles
            });
            
            alert(`${files.length} bon(s) d'entr√©e upload√©(s) avec succ√®s !`);
          };

          const removeUploadedFile = (articleId, fileIndex = null) => {
            const fileData = uploadedFiles[articleId];
            if (!fileData) return;
            
            if (fileIndex !== null) {
              // Supprimer un fichier sp√©cifique
              if (Array.isArray(fileData)) {
                const fileToRemove = fileData[fileIndex];
                if (fileToRemove && fileToRemove.url) {
                  URL.revokeObjectURL(fileToRemove.url);
                }
                
                const updatedFiles = fileData.filter((_, index) => index !== fileIndex);
                setUploadedFiles({
                  ...uploadedFiles,
                  [articleId]: updatedFiles.length > 0 ? updatedFiles : null
                });
              }
            } else {
              // Supprimer tous les fichiers
              if (Array.isArray(fileData)) {
                fileData.forEach(file => {
                  if (file && file.url) {
                    URL.revokeObjectURL(file.url);
                  }
                });
              } else if (fileData.url) {
                URL.revokeObjectURL(fileData.url);
              }
              
              setUploadedFiles({
                ...uploadedFiles,
                [articleId]: null
              });
            }
          };

          // Fonction pour g√©n√©rer un bon de livraison avec logo
          const generateDeliveryNote = (articleId) => {
            const article = articles.find(a => a.id === articleId);
            if (!article) return;

            const chantier = chantiers.find(c => c.id === article.chantierId);
            const currentUser = users.find(u => u.matricule === currentUserMatricule);
            const date = new Date().toLocaleString('fr-FR');
            
            // Cr√©er le contenu HTML avec logo
            const htmlContent = `
              <!DOCTYPE html>
              <html lang="fr">
              <head>
                <meta charset="UTF-8">
                <title>Bon de Livraison - ${article.nom}</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  .header { text-align: center; margin-bottom: 30px; }
                  .logo { width: 80px; height: 80px; margin: 0 auto 10px; }
                  .title { font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px; }
                  .subtitle { font-size: 16px; color: #6b7280; margin-bottom: 20px; }
                  .info-section { margin-bottom: 20px; }
                  .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                  .info-label { font-weight: bold; color: #374151; }
                  .info-value { color: #1f2937; }
                  .article-section { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0; }
                  .article-title { font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 10px; }
                  .quantity { font-size: 24px; font-weight: bold; color: #3b82f6; }
                  .footer { margin-top: 40px; text-align: center; color: #6b7280; font-size: 12px; }
                  @media print { body { margin: 0; } }
                </style>
              </head>
              <body>
                <div class="header">
                  <img src="./logo.jpg.jpg" alt="Logo NE Travaux" class="logo" onerror="this.style.display='none'">
                  <div class="title">NAIT EL KHALFAOUI TRAVAUX</div>
                  <div class="subtitle">Bon de Livraison</div>
                </div>
                
                <div class="info-section">
                  <div class="info-row">
                    <span class="info-label">Article :</span>
                    <span class="info-value">${article.icone} ${article.nom}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Quantit√© livr√©e :</span>
                    <span class="info-value">${article.quantite} unit√©s</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Chantier :</span>
                    <span class="info-value">${chantier ? chantier.nom : 'Non sp√©cifi√©'}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Responsable :</span>
                    <span class="info-value">${currentUser ? currentUser.nom : 'Non sp√©cifi√©'}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Date de livraison :</span>
                    <span class="info-value">${date}</span>
                  </div>
                </div>
                
                <div class="article-section">
                  <div class="article-title">D√©tails de l'article</div>
                  <div class="quantity">${article.icone} ${article.nom}</div>
                  <div style="margin-top: 10px;">
                    <strong>Stock disponible :</strong> ${article.quantite} unit√©s
                  </div>
                </div>
                
                <div style="margin-top: 30px;">
                  <div style="border-top: 2px solid #e5e7eb; padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                      <div>
                        <strong>Signature du livreur :</strong><br>
                        <div style="border-bottom: 1px solid #000; width: 150px; height: 40px; margin-top: 10px;"></div>
                      </div>
                      <div>
                        <strong>Signature du destinataire :</strong><br>
                        <div style="border-bottom: 1px solid #000; width: 150px; height: 40px; margin-top: 10px;"></div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="footer">
                  <p>Document g√©n√©r√© automatiquement par NE Travaux - Gestion de Stock</p>
                  <p>${date}</p>
                </div>
              </body>
              </html>
            `;

            // M√©thode am√©lior√©e pour le t√©l√©chargement
            try {
              // Cr√©er un blob avec le contenu HTML
              const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
              
              // Cr√©er un lien de t√©l√©chargement
              const downloadLink = document.createElement('a');
              downloadLink.href = URL.createObjectURL(blob);
              downloadLink.download = `Bon_Livraison_${article.nom}_${new Date().toISOString().split('T')[0]}.html`;
              downloadLink.style.display = 'none';
              
              // Ajouter le lien au DOM
              document.body.appendChild(downloadLink);
              
              // D√©clencher le t√©l√©chargement
              downloadLink.click();
              
              // Nettoyer imm√©diatement
              setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadLink.href);
              }, 1000);
              
              console.log(`Bon de livraison pour ${article.nom} g√©n√©r√© avec succ√®s !`);
              
            } catch (error) {
              console.error('Erreur lors de la g√©n√©ration du bon de livraison:', error);
              
              // M√©thode de fallback : ouvrir dans un nouvel onglet et imprimer
              try {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(htmlContent);
                newWindow.document.close();
                
                // Attendre que le contenu soit charg√© puis imprimer
                setTimeout(() => {
                  newWindow.print();
                }, 500);
                
              } catch (fallbackError) {
                console.error('Erreur de fallback:', fallbackError);
                alert('Erreur lors de la g√©n√©ration du bon de livraison. Veuillez r√©essayer.');
              }
            }
          };

          // Fonction pour g√©n√©rer et imprimer l'√©tat de stock (admin uniquement)
          const generateStockReport = () => {
            const date = new Date().toLocaleString('fr-FR');
            
            // R√©cup√©rer tous les chantiers et leurs articles
            const chantiersWithArticles = chantiers.map(chantier => {
              const articles = getArticlesForUser().find(c => c.id === chantier.id)?.articles || [];
              return {
                ...chantier,
                articles: articles
              };
            });

            // Cr√©er le contenu HTML du rapport
            const htmlContent = `
              <!DOCTYPE html>
              <html lang="fr">
              <head>
                <meta charset="UTF-8">
                <title>√âtat de Stock - NE Travaux</title>
                <style>
                  body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    color: #333;
                  }
                  .header { 
                    text-align: center; 
                    margin-bottom: 30px; 
                    border-bottom: 2px solid #3B82F6;
                    padding-bottom: 20px;
                  }
                  .logo { 
                    width: 80px; 
                    height: 80px; 
                    margin: 0 auto 10px; 
                  }
                  .title { 
                    font-size: 24px; 
                    font-weight: bold; 
                    color: #1f2937; 
                    margin-bottom: 5px; 
                  }
                  .subtitle { 
                    font-size: 16px; 
                    color: #6b7280; 
                    margin-bottom: 10px; 
                  }
                  .date { 
                    font-size: 14px; 
                    color: #6b7280; 
                    margin-bottom: 20px; 
                  }
                  .chantier-section { 
                    margin-bottom: 30px; 
                    page-break-inside: avoid;
                  }
                  .chantier-title { 
                    font-size: 18px; 
                    font-weight: bold; 
                    color: #1f2937; 
                    background: #f3f4f6; 
                    padding: 10px; 
                    border-radius: 5px; 
                    margin-bottom: 15px; 
                  }
                  .articles-table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-bottom: 20px; 
                  }
                  .articles-table th { 
                    background: #3B82F6; 
                    color: white; 
                    padding: 10px; 
                    text-align: left; 
                    font-weight: bold; 
                  }
                  .articles-table td { 
                    padding: 10px; 
                    border-bottom: 1px solid #e5e7eb; 
                  }
                  .articles-table tr:nth-child(even) { 
                    background: #f9fafb; 
                  }
                  .quantity { 
                    font-weight: bold; 
                    color: #3b82f6; 
                  }
                  .footer { 
                    margin-top: 40px; 
                    text-align: center; 
                    color: #6b7280; 
                    font-size: 12px; 
                    border-top: 1px solid #e5e7eb;
                    padding-top: 20px;
                  }
                  .summary { 
                    background: #f3f4f6; 
                    padding: 15px; 
                    border-radius: 5px; 
                    margin-bottom: 20px; 
                  }
                  .summary h3 { 
                    margin: 0 0 10px 0; 
                    color: #1f2937; 
                  }
                  .summary p { 
                    margin: 5px 0; 
                    color: #6b7280; 
                  }
                  @media print { 
                    body { margin: 0; } 
                    .chantier-section { page-break-inside: avoid; }
                  }
                </style>
              </head>
              <body>
                <div class="header">
                  <img src="./logo.jpg.jpg" alt="Logo NE Travaux" class="logo" onerror="this.style.display='none'">
                  <div class="title">NAIT EL KHALFAOUI TRAVAUX</div>
                  <div class="subtitle">√âtat de Stock - Rapport Complet</div>
                  <div class="date">G√©n√©r√© le : ${date}</div>
                </div>

                <div class="summary">
                  <h3>üìä R√©sum√© Global</h3>
                  <p><strong>Nombre de chantiers :</strong> ${chantiers.length}</p>
                  <p><strong>Nombre total d'articles :</strong> ${chantiersWithArticles.reduce((total, chantier) => total + chantier.articles.length, 0)}</p>
                  <p><strong>Statut des chantiers :</strong> ${chantiers.filter(c => c.statut === 'actif').length} actifs, ${chantiers.filter(c => c.statut === 'en_pause').length} en pause</p>
                </div>

                ${chantiersWithArticles.map(chantier => `
                  <div class="chantier-section">
                    <div class="chantier-title">
                      üèóÔ∏è ${chantier.nom} - ${chantier.description}
                      <span style="float: right; font-size: 14px; color: ${chantier.statut === 'actif' ? '#059669' : chantier.statut === 'en_pause' ? '#d97706' : '#6b7280'};">
                        ${chantier.statut === 'actif' ? '‚óè Actif' : chantier.statut === 'en_pause' ? '‚óè En pause' : '‚óè Termin√©'}
                      </span>
                    </div>
                    
                    ${chantier.articles.length > 0 ? `
                      <table class="articles-table">
                        <thead>
                          <tr>
                            <th>Article</th>
                            <th>Quantit√©</th>
                            <th>Responsable</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${chantier.articles.map(article => {
                            const pointeur = users.find(u => u.matricule === chantier.pointeurs[0]);
                            return `
                              <tr>
                                <td>${article.icone} ${article.nom}</td>
                                <td class="quantity">${article.quantite} unit√©s</td>
                                <td>${pointeur ? pointeur.nom : 'Non assign√©'}</td>
                              </tr>
                            `;
                          }).join('')}
                        </tbody>
                      </table>
                    ` : `
                      <p style="color: #6b7280; font-style: italic;">Aucun article assign√© √† ce chantier</p>
                    `}
                  </div>
                `).join('')}

                <div class="footer">
                  <p>Document g√©n√©r√© automatiquement par NE Travaux - Gestion de Stock</p>
                  <p>${date}</p>
                </div>
              </body>
              </html>
            `;

            // M√©thode am√©lior√©e de t√©l√©chargement
            try {
              // Cr√©er un blob avec le contenu HTML
              const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
              
              // Cr√©er un lien de t√©l√©chargement
              const downloadLink = document.createElement('a');
              downloadLink.href = URL.createObjectURL(blob);
              downloadLink.download = `Etat_Stock_NE_Travaux_${new Date().toISOString().split('T')[0]}.html`;
              downloadLink.style.display = 'none';
              
              // Ajouter le lien au DOM
              document.body.appendChild(downloadLink);
              
              // D√©clencher le t√©l√©chargement
              downloadLink.click();
              
              // Nettoyer imm√©diatement
              setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadLink.href);
              }, 1000);
              
              console.log('Rapport d\'√©tat de stock g√©n√©r√© avec succ√®s !');
              
            } catch (error) {
              console.error('Erreur lors de la g√©n√©ration du rapport:', error);
              
              // M√©thode de fallback : ouvrir dans un nouvel onglet et imprimer
              try {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(htmlContent);
                newWindow.document.close();
                
                // Attendre que le contenu soit charg√© puis imprimer
                setTimeout(() => {
                  newWindow.print();
                }, 500);
                
              } catch (fallbackError) {
                console.error('Erreur de fallback:', fallbackError);
                alert('Erreur lors de la g√©n√©ration du rapport. Veuillez r√©essayer.');
              }
            }
          };

                     return (
             <div className="space-y-6">
               <div className="flex justify-between items-center">
                 <h2 className="text-2xl font-bold text-gray-800">
                   {isAdmin ? 'Gestion du Stock - Vue Globale' : `Stock - ${currentUser.chantier}`}
                 </h2>
                 {isAdmin && (
                   <button
                     onClick={() => generateStockReport()}
                     className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2 shadow-md"
                   >
                     <span>üìÑ</span>
                     <span>Imprimer √âtat de Stock</span>
                   </button>
                 )}
               </div>

               {isAdmin ? (
                 // Vue admin : tous les chantiers
                 <div className="space-y-8">
                   {/* Ic√¥nes des chantiers pour navigation rapide */}
                   <div className="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/20">
                     <h3 className="text-lg font-semibold text-gray-800 mb-4">üèóÔ∏è Navigation par Chantier</h3>
                     <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                       {getArticlesForUser().map(chantier => (
                         <button
                           key={chantier.id}
                           onClick={() => {
                             const element = document.getElementById(`chantier-${chantier.id}`);
                             if (element) {
                               element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                             }
                           }}
                           className="flex flex-col items-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-lg border-2 border-blue-200 hover:border-blue-400 hover:from-blue-100 hover:to-indigo-200 transition-all duration-200 shadow-md hover:shadow-lg"
                         >
                           <span className="text-3xl mb-2">üèóÔ∏è</span>
                           <span className="text-sm font-medium text-gray-800 text-center">{chantier.nom}</span>
                           <span className={`px-2 py-1 rounded text-xs font-medium mt-2 ${
                             chantier.statut === 'actif' ? 'bg-green-100 text-green-800' :
                             chantier.statut === 'en_pause' ? 'bg-yellow-100 text-yellow-800' :
                             'bg-gray-100 text-gray-800'
                           }`}>
                             {chantier.statut === 'actif' ? 'Actif' : 
                              chantier.statut === 'en_pause' ? 'En pause' : 'Termin√©'}
                           </span>
                         </button>
                       ))}
                     </div>
                   </div>

                   {/* Sections des chantiers */}
                   {getArticlesForUser().map(chantier => (
                     <div key={chantier.id} id={`chantier-${chantier.id}`} className="bg-white p-6 rounded-lg shadow-md">
                       <div className="mb-6">
                         <h3 className="text-xl font-semibold text-gray-800 mb-2">
                           üèóÔ∏è {chantier.nom}
                         </h3>
                         <p className="text-sm text-gray-600">{chantier.description}</p>
                         <div className="flex items-center space-x-2 mt-2">
                           <span className={`px-2 py-1 rounded text-xs font-medium ${
                             chantier.statut === 'actif' ? 'bg-green-100 text-green-800' :
                             chantier.statut === 'en_pause' ? 'bg-yellow-100 text-yellow-800' :
                             'bg-gray-100 text-gray-800'
                           }`}>
                             {chantier.statut === 'actif' ? 'Actif' : 
                              chantier.statut === 'en_pause' ? 'En pause' : 'Termin√©'}
                           </span>
                         </div>
                       </div>

                       <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         {chantier.articles.map(article => (
                           <div key={article.id} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                             <div className="mb-3">
                               <h4 className="text-lg font-semibold text-gray-800">
                                 {article.icone} {article.nom}
                               </h4>
                               <p className="text-xl font-bold text-blue-600">{article.quantite}</p>
                             </div>

                             <div className="space-y-2">
                               <div>
                                 <label className="block text-sm font-medium text-gray-700 mb-1">Entr√©e</label>
                                 <div className="flex space-x-2">
                                   <input
                                     type="number"
                                     min="0"
                                     placeholder="0"
                                     value={pendingEntrees[article.id] || ''}
                                     className="flex-1 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                     onChange={(e) => handleStockUpdate(article.id, 'entree', e.target.value)}
                                   />
                                   <button
                                     onClick={() => handleValidateStock(article.id, 'entree')}
                                     className="px-3 py-1 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 transition-colors"
                                   >
                                     ‚úÖ Valider
                                   </button>
                                 </div>
                                 <div className="mt-2">
                                   <label className="cursor-pointer bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs font-medium transition-colors inline-block">
                                     üìé Upload Multiple
                                     <input
                                       type="file"
                                       accept="image/*,.pdf"
                                       multiple
                                       className="hidden"
                                       onChange={(e) => handleFileUpload(article.id, e)}
                                     />
                                   </label>
                                 </div>
                                 {uploadedFiles[article.id] && (
                                   <div className="mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs">
                                     {Array.isArray(uploadedFiles[article.id]) ? (
                                       uploadedFiles[article.id].map((file, index) => (
                                         <div key={index} className="mb-2 last:mb-0">
                                           <div className="flex items-center justify-between">
                                             <span className="text-green-700">üìé {file.name}</span>
                                             <button
                                               onClick={() => removeUploadedFile(article.id, index)}
                                               className="text-red-500 hover:text-red-700"
                                             >
                                               ‚úï
                                             </button>
                                           </div>
                                           {file.type.startsWith('image/') && (
                                             <img
                                               src={file.url}
                                               alt="Aper√ßu"
                                               className="mt-1 w-full h-16 object-cover rounded"
                                             />
                                           )}
                                         </div>
                                       ))
                                     ) : (
                                       <div className="flex items-center justify-between">
                                         <span className="text-green-700">üìé {uploadedFiles[article.id].name}</span>
                                         <button
                                           onClick={() => removeUploadedFile(article.id)}
                                           className="text-red-500 hover:text-red-700"
                                         >
                                           ‚úï
                                         </button>
                                       </div>
                                     )}
                                   </div>
                                 )}
                               </div>
                               <div>
                                 <label className="block text-sm font-medium text-gray-700 mb-1">Sortie</label>
                                 <div className="flex space-x-2">
                                   <input
                                     type="number"
                                     min="0"
                                     placeholder="0"
                                     value={pendingSorties[article.id] || ''}
                                     className="flex-1 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                     onChange={(e) => handleStockUpdate(article.id, 'sortie', e.target.value)}
                                   />
                                   <button
                                     onClick={() => handleValidateStock(article.id, 'sortie')}
                                     className="px-3 py-1 bg-red-600 text-white rounded text-xs font-medium hover:bg-red-700 transition-colors"
                                   >
                                     ‚úÖ Valider
                                   </button>
                                 </div>
                               </div>
                             </div>

                             <div className="mt-3 space-y-2">
                               <button
                                 onClick={() => handleCommande(article.id)}
                                 className="w-full px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                               >
                                 üìã Commander
                               </button>
                               <input
                                 type="number"
                                 placeholder="Quantit√©"
                                 value={commandeQuantite[article.id] || ''}
                                 onChange={(e) => setCommandeQuantite({...commandeQuantite, [article.id]: e.target.value})}
                                 className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 text-sm"
                               />
                               <input
                                 type="text"
                                 placeholder="Note/Message (optionnel)"
                                 value={commandeNote[article.id] || ''}
                                 onChange={(e) => setCommandeNote({...commandeNote, [article.id]: e.target.value})}
                                 className="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 text-sm"
                               />
                               <button
                                 onClick={() => generateDeliveryNote(article.id)}
                                 className="w-full px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
                               >
                                 üìÑ Bon de Livraison
                               </button>
                             </div>
                           </div>
                         ))}
                       </div>
                     </div>
                   ))}
                 </div>
               ) : (
                 // Vue pointeur : uniquement son chantier
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   {getArticlesForUser().map(article => (
                     <div key={article.id} className="bg-white p-6 rounded-lg shadow-md">
                       <div className="mb-4">
                         <h3 className="text-xl font-semibold text-gray-800">
                           {article.icone} {article.nom}
                         </h3>
                         <p className="text-2xl font-bold text-blue-600">{article.quantite}</p>
                       </div>

                       <div className="space-y-3">
                         <div>
                           <label className="block text-sm font-medium text-gray-700 mb-1">Entr√©e</label>
                           <div className="flex space-x-2">
                             <input
                               type="number"
                               min="0"
                               placeholder="0"
                               value={pendingEntrees[article.id] || ''}
                               className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               onChange={(e) => handleStockUpdate(article.id, 'entree', e.target.value)}
                             />
                             <button
                               onClick={() => handleValidateStock(article.id, 'entree')}
                               className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors"
                             >
                               ‚úÖ Valider
                             </button>
                           </div>
                           <div className="mt-2">
                             <label className="cursor-pointer bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors inline-block">
                               üìé Upload Multiple
                               <input
                                 type="file"
                                 accept="image/*,.pdf"
                                 multiple
                                 className="hidden"
                                 onChange={(e) => handleFileUpload(article.id, e)}
                               />
                             </label>
                           </div>
                           {uploadedFiles[article.id] && (
                             <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg text-sm">
                               {Array.isArray(uploadedFiles[article.id]) ? (
                                 uploadedFiles[article.id].map((file, index) => (
                                   <div key={index} className="mb-2 last:mb-0">
                                     <div className="flex items-center justify-between">
                                       <span className="text-green-700">üìé {file.name}</span>
                                       <button
                                         onClick={() => removeUploadedFile(article.id, index)}
                                         className="text-red-500 hover:text-red-700"
                                       >
                                         ‚úï
                                       </button>
                                     </div>
                                     {file.type.startsWith('image/') && (
                                       <img
                                         src={file.url}
                                         alt="Aper√ßu"
                                         className="mt-2 w-full h-20 object-cover rounded"
                                       />
                                     )}
                                   </div>
                                 ))
                               ) : (
                                 <div className="flex items-center justify-between">
                                   <span className="text-green-700">üìé {uploadedFiles[article.id].name}</span>
                                   <button
                                     onClick={() => removeUploadedFile(article.id)}
                                     className="text-red-500 hover:text-red-700"
                                   >
                                     ‚úï
                                   </button>
                                 </div>
                               )}
                             </div>
                           )}
                         </div>
                         <div>
                           <label className="block text-sm font-medium text-gray-700 mb-1">Sortie</label>
                           <div className="flex space-x-2">
                             <input
                               type="number"
                               min="0"
                               placeholder="0"
                               value={pendingSorties[article.id] || ''}
                               className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               onChange={(e) => handleStockUpdate(article.id, 'sortie', e.target.value)}
                             />
                             <button
                               onClick={() => handleValidateStock(article.id, 'sortie')}
                               className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors"
                             >
                               ‚úÖ Valider
                             </button>
                           </div>
                         </div>
                       </div>

                       <div className="mt-4 space-y-2">
                         <button
                           onClick={() => handleCommande(article.id)}
                           className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                         >
                           üìã Commander
                         </button>
                         <input
                           type="number"
                           placeholder="Quantit√© √† commander"
                           value={commandeQuantite[article.id] || ''}
                           onChange={(e) => setCommandeQuantite({...commandeQuantite, [article.id]: e.target.value})}
                           className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                         />
                         <input
                           type="text"
                           placeholder="Note/Message (optionnel)"
                           value={commandeNote[article.id] || ''}
                           onChange={(e) => setCommandeNote({...commandeNote, [article.id]: e.target.value})}
                           className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                         />
                         <button
                           onClick={() => generateDeliveryNote(article.id)}
                           className="w-full px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors"
                         >
                           üìÑ Bon de Livraison
                         </button>
                       </div>
                     </div>
                   ))}
                 </div>
               )}
             </div>
           );
        }

                 // Composant Commandes
         function Commands({ commandes, articles, currentUser, isAdmin, chantiers }) {
           const getArticleIcon = (articleId) => {
             const article = articles.find(a => a.id === articleId);
             return article ? article.icone : 'üì¶';
           };

           const getChantierName = (chantierId) => {
             const chantier = chantiers.find(c => c.id === chantierId);
             return chantier ? chantier.nom : 'Inconnu';
           };

           // Filtrer les commandes selon le r√¥le
           const getCommandesForUser = () => {
             if (isAdmin) {
               return commandes; // Admin voit toutes les commandes
             } else {
               // Pointeur voit uniquement les commandes de son chantier
               const userChantier = chantiers.find(c => c.nom === currentUser.chantier);
               if (userChantier) {
                 return commandes.filter(commande => {
                   const article = articles.find(a => a.id === commande.articleId);
                   return article && article.chantierId === userChantier.id;
                 });
               }
               return [];
             }
           };

                     return (
             <div className="space-y-6">
               <h2 className="text-2xl font-bold text-gray-800">
                 {isAdmin ? 'Commandes - Vue Globale' : `Commandes - ${currentUser.chantier}`}
               </h2>

               <div className="bg-white rounded-lg shadow-md overflow-hidden">
                 <div className="overflow-x-auto">
                   <table className="w-full">
                     <thead className="bg-gray-50">
                       <tr>
                         <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                           Article
                         </th>
                         <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                           Quantit√©
                         </th>
                         {isAdmin && (
                           <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                             Chantier
                           </th>
                         )}
                         <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                           Utilisateur
                         </th>
                         <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                           Date
                         </th>
                         {isAdmin && (
                           <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                             Note/Message
                           </th>
                         )}
                       </tr>
                     </thead>
                     <tbody className="bg-white divide-y divide-gray-200">
                       {getCommandesForUser().length === 0 ? (
                         <tr>
                           <td colSpan={isAdmin ? "6" : "4"} className="px-6 py-4 text-center text-gray-500">
                             Aucune commande pour le moment
                           </td>
                         </tr>
                       ) : (
                         getCommandesForUser().map(commande => {
                           const article = articles.find(a => a.id === commande.articleId);
                           return (
                             <tr key={commande.id} className="hover:bg-gray-50">
                               <td className="px-6 py-4 whitespace-nowrap">
                                 <div className="flex items-center">
                                   <span className="text-xl mr-2">{getArticleIcon(commande.articleId)}</span>
                                   <span className="text-sm font-medium text-gray-900">{commande.articleNom}</span>
                                 </div>
                               </td>
                               <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                 {commande.quantite}
                               </td>
                               {isAdmin && (
                                 <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                   {article ? getChantierName(article.chantierId) : 'Inconnu'}
                                 </td>
                               )}
                               <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                 {commande.userName}
                               </td>
                               <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                 {commande.date}
                               </td>
                               {isAdmin && (
                                 <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                   {commande.note || '-'}
                                 </td>
                               )}
                             </tr>
                           );
                         })
                       )}
                     </tbody>
                   </table>
                 </div>
               </div>
             </div>
           );
        }

                 // Composant Admin
         function Admin({ users, articles, chantiers, onUpdateUser, onDeleteUser, onAddArticle, onDeleteArticle, onAddChantier, onDeleteChantier, onUpdateChantier }) {
           const [editingUser, setEditingUser] = useState(null);
           const [editingPassword, setEditingPassword] = useState(null);
           const [editingChantier, setEditingChantier] = useState(null);
           const [newArticle, setNewArticle] = useState({ nom: '', icone: 'üì¶', quantite: 0, chantierId: 1 });
           const [newChantier, setNewChantier] = useState({ nom: '', description: '', statut: 'actif' });
           const [showAddArticleForm, setShowAddArticleForm] = useState(false);
           const [showAddChantierForm, setShowAddChantierForm] = useState(false);

           const handleUpdateUser = (matricule, updates) => {
             onUpdateUser(matricule, updates);
             setEditingUser(null);
           };

           const handleUpdatePassword = (matricule, newPassword) => {
             onUpdateUser(matricule, { password: newPassword });
             setEditingPassword(null);
             alert('Mot de passe modifi√© avec succ√®s !');
           };

           const handleDeleteUser = (matricule) => {
             if (window.confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) {
               onDeleteUser(matricule);
             }
           };

           const handleAddArticle = () => {
             if (newArticle.nom.trim() && newArticle.quantite >= 0) {
               onAddArticle(newArticle);
               setNewArticle({ nom: '', icone: 'üì¶', quantite: 0, chantierId: 1 });
               setShowAddArticleForm(false);
             } else {
               alert('Veuillez remplir tous les champs correctement.');
             }
           };

           const handleDeleteArticle = (articleId) => {
             if (window.confirm('√ätes-vous s√ªr de vouloir supprimer cet article ?')) {
               onDeleteArticle(articleId);
             }
           };

           const handleAddChantier = () => {
             if (newChantier.nom.trim()) {
               onAddChantier(newChantier);
               setNewChantier({ nom: '', description: '', statut: 'actif' });
               setShowAddChantierForm(false);
             } else {
               alert('Veuillez entrer un nom de chantier.');
             }
           };

           const handleUpdateChantier = (chantierId, updates) => {
             onUpdateChantier(chantierId, updates);
             setEditingChantier(null);
           };

           const handleDeleteChantier = (chantierId) => {
             if (window.confirm('√ätes-vous s√ªr de vouloir supprimer ce chantier ?')) {
               onDeleteChantier(chantierId);
             }
           };

           return (
             <div className="space-y-8">
                               <div className="flex justify-between items-center">
                  <div className="flex items-center space-x-4">
                    <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                      <img src="./logo.jpg.jpg" alt="Logo" className="w-10 h-10 object-contain rounded-full" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                      <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm" style={{display: 'none'}}>NEK</div>
                    </div>
                                         <div>
                       <h2 className="text-3xl font-bold text-gray-800">Administration</h2>
                       <div className="text-sm text-gray-600">
                         Gestion des utilisateurs, articles et chantiers
                       </div>
                     </div>
                  </div>
                </div>
               
                               <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  {/* Gestion des Utilisateurs */}
                  <div className="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/20">
                   <div className="flex justify-between items-center mb-6">
                     <h3 className="text-xl font-semibold text-gray-800">Utilisateurs ({users.length})</h3>
                     <div className="text-sm text-gray-600">Gestion des pointeurs</div>
                   </div>
                   
                   <div className="space-y-4">
                     {users.map(user => (
                       <div key={user.matricule} className="bg-gray-50/80 p-4 rounded-lg border border-gray-200/50">
                                                   {editingUser === user.matricule ? (
                            <div className="space-y-3">
                              <div className="flex justify-between items-center">
                                <span className="font-medium text-gray-800">{user.nom}</span>
                                <span className="text-sm font-mono text-gray-500">{user.matricule}</span>
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">Chantier</label>
                                  <input
                                    type="text"
                                    defaultValue={user.chantier}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    onKeyPress={(e) => {
                                      if (e.key === 'Enter') {
                                        handleUpdateUser(user.matricule, { chantier: e.target.value });
                                      }
                                    }}
                                  />
                                </div>
                                <div className="flex space-x-2">
                                  <button
                                    onClick={() => handleUpdateUser(user.matricule, { chantier: document.querySelector(`input[defaultValue="${user.chantier}"]`).value })}
                                    className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                                  >
                                    ‚úÖ Sauvegarder
                                  </button>
                                  <button
                                    onClick={() => setEditingUser(null)}
                                    className="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                  >
                                    ‚ùå Annuler
                                  </button>
                                </div>
                              </div>
                            </div>
                          ) : editingPassword === user.matricule ? (
                            <div className="space-y-3">
                              <div className="flex justify-between items-center">
                                <span className="font-medium text-gray-800">{user.nom}</span>
                                <span className="text-sm font-mono text-gray-500">{user.matricule}</span>
                              </div>
                              <div className="space-y-3">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">Nouveau mot de passe</label>
                                  <input
                                    type="password"
                                    id={`password-${user.matricule}`}
                                    placeholder="Nouveau mot de passe"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                                <div className="flex space-x-2">
                                  <button
                                    onClick={() => {
                                      const newPassword = document.getElementById(`password-${user.matricule}`).value;
                                      if (newPassword.trim()) {
                                        handleUpdatePassword(user.matricule, newPassword);
                                      } else {
                                        alert('Veuillez entrer un mot de passe valide.');
                                      }
                                    }}
                                    className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                                  >
                                    ‚úÖ Sauvegarder
                                  </button>
                                  <button
                                    onClick={() => setEditingPassword(null)}
                                    className="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                  >
                                    ‚ùå Annuler
                                  </button>
                                </div>
                              </div>
                            </div>
                          ) : (
                           <div className="flex justify-between items-center">
                             <div>
                               <p className="font-medium text-gray-800">{user.nom}</p>
                               <p className="text-sm text-gray-600">
                                 {user.role === 'admin' ? 'Administrateur' : `Pointeur - ${user.chantier}`}
                               </p>
                             </div>
                             <div className="flex items-center space-x-2">
                               <span className="text-sm font-mono text-gray-500">{user.matricule}</span>
                                                               {user.role !== 'admin' && (
                                  <>
                                    <button
                                      onClick={() => setEditingUser(user.matricule)}
                                      className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                                    >
                                      ‚úèÔ∏è Modifier
                                    </button>
                                    <button
                                      onClick={() => setEditingPassword(user.matricule)}
                                      className="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-sm"
                                    >
                                      üîê Mot de passe
                                    </button>
                                    <button
                                      onClick={() => handleDeleteUser(user.matricule)}
                                      className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm"
                                    >
                                      üóëÔ∏è Supprimer
                                    </button>
                                  </>
                                )}
                             </div>
                           </div>
                         )}
                       </div>
                     ))}
                   </div>
                 </div>

                 {/* Gestion des Articles */}
                 <div className="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/20">
                   <div className="flex justify-between items-center mb-6">
                     <h3 className="text-xl font-semibold text-gray-800">Articles ({articles.length})</h3>
                     <button
                       onClick={() => setShowAddArticleForm(!showAddArticleForm)}
                       className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                     >
                       ‚ûï Ajouter Article
                     </button>
                   </div>

                   {/* Formulaire d'ajout d'article */}
                   {showAddArticleForm && (
                     <div className="bg-blue-50/80 p-4 rounded-lg border border-blue-200/50 mb-4">
                       <h4 className="font-medium text-gray-800 mb-3">Nouvel Article</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                           <div>
                             <label className="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                             <input
                               type="text"
                               value={newArticle.nom}
                               onChange={(e) => setNewArticle({...newArticle, nom: e.target.value})}
                               placeholder="Nom de l'article"
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                             />
                           </div>
                           <div>
                             <label className="block text-sm font-medium text-gray-700 mb-1">Ic√¥ne</label>
                             <select
                               value={newArticle.icone}
                               onChange={(e) => setNewArticle({...newArticle, icone: e.target.value})}
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                             >
                               <option value="üì¶">üì¶ G√©n√©ral</option>
                               <option value="üõ†Ô∏è">üõ†Ô∏è Outils</option>
                               <option value="üèñÔ∏è">üèñÔ∏è Mat√©riaux</option>
                               <option value="üß±">üß± Construction</option>
                               <option value="üîß">üîß √âquipement</option>
                               <option value="‚ö°">‚ö° √âlectrique</option>
                               <option value="üö∞">üö∞ Plomberie</option>
                               <option value="üé®">üé® Finition</option>
                             </select>
                           </div>
                           <div>
                             <label className="block text-sm font-medium text-gray-700 mb-1">Chantier</label>
                             <select
                               value={newArticle.chantierId}
                               onChange={(e) => setNewArticle({...newArticle, chantierId: parseInt(e.target.value)})}
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                             >
                               {chantiers.map(chantier => (
                                 <option key={chantier.id} value={chantier.id}>
                                   {chantier.nom}
                                 </option>
                               ))}
                             </select>
                           </div>
                           <div>
                             <label className="block text-sm font-medium text-gray-700 mb-1">Quantit√©</label>
                             <input
                               type="number"
                               min="0"
                               value={newArticle.quantite}
                               onChange={(e) => setNewArticle({...newArticle, quantite: parseInt(e.target.value) || 0})}
                               placeholder="0"
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                             />
                           </div>
                         </div>
                       <div className="flex space-x-2 mt-3">
                         <button
                           onClick={handleAddArticle}
                           className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                         >
                           ‚úÖ Ajouter
                         </button>
                         <button
                           onClick={() => setShowAddArticleForm(false)}
                           className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                         >
                           ‚ùå Annuler
                         </button>
                       </div>
                     </div>
                   )}
                   
                   <div className="space-y-3">
                     {articles.map(article => (
                       <div key={article.id} className="flex justify-between items-center p-3 bg-gray-50/80 rounded-lg border border-gray-200/50">
                         <div className="flex items-center space-x-3">
                           <span className="text-2xl">{article.icone}</span>
                           <div>
                             <p className="font-medium text-gray-800">{article.nom}</p>
                             <p className="text-sm text-gray-600">Stock: {article.quantite} unit√©s</p>
                           </div>
                         </div>
                         <button
                           onClick={() => handleDeleteArticle(article.id)}
                           className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm"
                         >
                           üóëÔ∏è Supprimer
                         </button>
                       </div>
                     ))}
                   </div>
                 </div>

                 {/* Gestion des Chantiers */}
                 <div className="bg-white/95 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-white/20">
                   <div className="flex justify-between items-center mb-6">
                     <h3 className="text-xl font-semibold text-gray-800">Chantiers ({chantiers.length})</h3>
                     <button
                       onClick={() => setShowAddChantierForm(!showAddChantierForm)}
                       className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                     >
                       ‚ûï Ajouter Chantier
                     </button>
                   </div>

                   {/* Formulaire d'ajout de chantier */}
                   {showAddChantierForm && (
                     <div className="bg-blue-50/80 p-4 rounded-lg border border-blue-200/50 mb-4">
                       <h4 className="font-medium text-gray-800 mb-3">Nouveau Chantier</h4>
                       <div className="space-y-3">
                         <div>
                           <label className="block text-sm font-medium text-gray-700 mb-1">Nom du chantier</label>
                           <input
                             type="text"
                             value={newChantier.nom}
                             onChange={(e) => setNewChantier({...newChantier, nom: e.target.value})}
                             placeholder="Nom du chantier"
                             className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           />
                         </div>
                         <div>
                           <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                           <input
                             type="text"
                             value={newChantier.description}
                             onChange={(e) => setNewChantier({...newChantier, description: e.target.value})}
                             placeholder="Description du chantier"
                             className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           />
                         </div>
                         <div>
                           <label className="block text-sm font-medium text-gray-700 mb-1">Statut</label>
                           <select
                             value={newChantier.statut}
                             onChange={(e) => setNewChantier({...newChantier, statut: e.target.value})}
                             className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           >
                             <option value="actif">Actif</option>
                             <option value="en_pause">En pause</option>
                             <option value="termine">Termin√©</option>
                           </select>
                         </div>
                       </div>
                       <div className="flex space-x-2 mt-3">
                         <button
                           onClick={handleAddChantier}
                           className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                         >
                           ‚úÖ Ajouter
                         </button>
                         <button
                           onClick={() => setShowAddChantierForm(false)}
                           className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                         >
                           ‚ùå Annuler
                         </button>
                       </div>
                     </div>
                   )}
                   
                   <div className="space-y-3">
                     {chantiers.map(chantier => (
                       <div key={chantier.id} className="bg-gray-50/80 p-3 rounded-lg border border-gray-200/50">
                         {editingChantier === chantier.id ? (
                           <div className="space-y-3">
                             <div className="flex justify-between items-center">
                               <span className="font-medium text-gray-800">{chantier.nom}</span>
                               <span className={`px-2 py-1 rounded text-xs font-medium ${
                                 chantier.statut === 'actif' ? 'bg-green-100 text-green-800' :
                                 chantier.statut === 'en_pause' ? 'bg-yellow-100 text-yellow-800' :
                                 'bg-gray-100 text-gray-800'
                               }`}>
                                 {chantier.statut === 'actif' ? 'Actif' : 
                                  chantier.statut === 'en_pause' ? 'En pause' : 'Termin√©'}
                               </span>
                             </div>
                             <div className="space-y-2">
                               <div>
                                 <label className="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                                 <input
                                   type="text"
                                   defaultValue={chantier.nom}
                                   className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onKeyPress={(e) => {
                                     if (e.key === 'Enter') {
                                       handleUpdateChantier(chantier.id, { nom: e.target.value });
                                     }
                                   }}
                                 />
                               </div>
                               <div>
                                 <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                 <input
                                   type="text"
                                   defaultValue={chantier.description}
                                   className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onKeyPress={(e) => {
                                     if (e.key === 'Enter') {
                                       handleUpdateChantier(chantier.id, { description: e.target.value });
                                     }
                                   }}
                                 />
                               </div>
                               <div className="flex space-x-2">
                                 <button
                                   onClick={() => handleUpdateChantier(chantier.id, { 
                                     nom: document.querySelector(`input[defaultValue="${chantier.nom}"]`).value,
                                     description: document.querySelector(`input[defaultValue="${chantier.description}"]`).value
                                   })}
                                   className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                                 >
                                   ‚úÖ Sauvegarder
                                 </button>
                                 <button
                                   onClick={() => setEditingChantier(null)}
                                   className="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                 >
                                   ‚ùå Annuler
                                 </button>
                               </div>
                             </div>
                           </div>
                         ) : (
                           <div className="flex justify-between items-center">
                             <div>
                               <p className="font-medium text-gray-800">{chantier.nom}</p>
                               <p className="text-sm text-gray-600">{chantier.description}</p>
                               <div className="flex items-center space-x-2 mt-1">
                                 <span className={`px-2 py-1 rounded text-xs font-medium ${
                                   chantier.statut === 'actif' ? 'bg-green-100 text-green-800' :
                                   chantier.statut === 'en_pause' ? 'bg-yellow-100 text-yellow-800' :
                                   'bg-gray-100 text-gray-800'
                                 }`}>
                                   {chantier.statut === 'actif' ? 'Actif' : 
                                    chantier.statut === 'en_pause' ? 'En pause' : 'Termin√©'}
                                 </span>
                                 <span className="text-xs text-gray-500">
                                   {users.filter(u => u.chantier === chantier.nom).length} pointeur(s)
                                 </span>
                               </div>
                             </div>
                             <div className="flex items-center space-x-2">
                               <button
                                 onClick={() => setEditingChantier(chantier.id)}
                                 className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                               >
                                 ‚úèÔ∏è Modifier
                               </button>
                               <button
                                 onClick={() => handleDeleteChantier(chantier.id)}
                                 className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm"
                               >
                                 üóëÔ∏è Supprimer
                               </button>
                             </div>
                           </div>
                         )}
                       </div>
                     ))}
                   </div>
                 </div>
               </div>
             </div>
           );
         }

        // Composant Historique (r√©serv√© √† l'admin)
        function Historique({ historique, articles, users, chantiers }) {
          const [selectedChantier, setSelectedChantier] = useState('all');
          const [selectedPeriod, setSelectedPeriod] = useState('all');
          const [searchTerm, setSearchTerm] = useState('');

          // Filtrer l'historique selon les crit√®res
          const filteredHistorique = historique.filter(mouvement => {
            // Filtre par chantier
            if (selectedChantier !== 'all' && mouvement.chantierId !== parseInt(selectedChantier)) {
              return false;
            }

            // Filtre par p√©riode
            if (selectedPeriod !== 'all') {
              const mouvementDate = new Date(mouvement.date);
              const now = new Date();
              const diffTime = Math.abs(now - mouvementDate);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              if (selectedPeriod === 'today' && diffDays > 1) return false;
              if (selectedPeriod === 'week' && diffDays > 7) return false;
              if (selectedPeriod === 'month' && diffDays > 30) return false;
            }

            // Filtre par recherche
            if (searchTerm) {
              const article = articles.find(a => a.id === mouvement.articleId);
              const user = users.find(u => u.matricule === mouvement.userId);
              const chantier = chantiers.find(c => c.id === mouvement.chantierId);
              
              const searchLower = searchTerm.toLowerCase();
              return (
                (article && article.nom.toLowerCase().includes(searchLower)) ||
                (user && user.nom.toLowerCase().includes(searchLower)) ||
                (chantier && chantier.nom.toLowerCase().includes(searchLower)) ||
                mouvement.notes.toLowerCase().includes(searchLower)
              );
            }

            return true;
          });

          // Trier par date (plus r√©cent en premier)
          const sortedHistorique = filteredHistorique.sort((a, b) => 
            new Date(b.date) - new Date(a.date)
          );

          const formatDate = (dateString) => {
            return new Date(dateString).toLocaleString('fr-FR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          };

          const getArticleInfo = (articleId) => {
            const article = articles.find(a => a.id === articleId);
            return article ? { nom: article.nom, icone: article.icone } : { nom: 'Article inconnu', icone: '‚ùì' };
          };

          const getUserInfo = (userId) => {
            const user = users.find(u => u.matricule === userId);
            return user ? user.nom : 'Utilisateur inconnu';
          };

          const getChantierInfo = (chantierId) => {
            const chantier = chantiers.find(c => c.id === chantierId);
            return chantier ? chantier.nom : 'Chantier inconnu';
          };

          return (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                    <span className="mr-3">üìä</span>
                    Historique des Mouvements
                  </h2>
                  <div className="text-sm text-gray-600">
                    {sortedHistorique.length} mouvement(s) trouv√©(s)
                  </div>
                </div>

                {/* Filtres */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Chantier</label>
                    <select
                      value={selectedChantier}
                      onChange={(e) => setSelectedChantier(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Tous les chantiers</option>
                      {chantiers.map(chantier => (
                        <option key={chantier.id} value={chantier.id}>
                          {chantier.nom}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">P√©riode</label>
                    <select
                      value={selectedPeriod}
                      onChange={(e) => setSelectedPeriod(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">Toute la p√©riode</option>
                      <option value="today">Aujourd'hui</option>
                      <option value="week">Cette semaine</option>
                      <option value="month">Ce mois</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Recherche</label>
                    <input
                      type="text"
                      placeholder="Article, utilisateur, chantier..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  <div className="flex items-end">
                    <button
                      onClick={() => {
                        setSelectedChantier('all');
                        setSelectedPeriod('all');
                        setSearchTerm('');
                      }}
                      className="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                    >
                      üîÑ R√©initialiser
                    </button>
                  </div>
                </div>

                {/* Liste des mouvements */}
                <div className="space-y-4">
                  {sortedHistorique.length > 0 ? (
                    sortedHistorique.map(mouvement => {
                      const articleInfo = getArticleInfo(mouvement.articleId);
                      const userInfo = getUserInfo(mouvement.userId);
                      const chantierInfo = getChantierInfo(mouvement.chantierId);

                      return (
                        <div
                          key={mouvement.id}
                          className={`p-4 rounded-lg border-l-4 ${
                            mouvement.type === 'entree' 
                              ? 'bg-green-50 border-green-500' 
                              : 'bg-red-50 border-red-500'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                              <div className={`p-2 rounded-full ${
                                mouvement.type === 'entree' ? 'bg-green-100' : 'bg-red-100'
                              }`}>
                                {mouvement.type === 'entree' ? '‚ûï' : '‚ûñ'}
                              </div>
                              <div>
                                <div className="flex items-center space-x-2">
                                  <span className="font-medium text-gray-800">
                                    {articleInfo.icone} {articleInfo.nom}
                                  </span>
                                  <span className={`px-2 py-1 rounded text-xs font-medium ${
                                    mouvement.type === 'entree' 
                                      ? 'bg-green-100 text-green-800' 
                                      : 'bg-red-100 text-red-800'
                                  }`}>
                                    {mouvement.type === 'entree' ? 'Entr√©e' : 'Sortie'}
                                  </span>
                                </div>
                                <div className="text-sm text-gray-600 mt-1">
                                  <span className="font-medium">{mouvement.quantite} unit√©s</span>
                                  {mouvement.notes && (
                                    <span className="ml-2">‚Ä¢ {mouvement.notes}</span>
                                  )}
                                </div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-sm text-gray-600">
                                <div>üë§ {userInfo}</div>
                                <div>üèóÔ∏è {chantierInfo}</div>
                                <div>üìÖ {formatDate(mouvement.date)}</div>
                                {mouvement.uploadedFiles && mouvement.uploadedFiles.length > 0 && (
                                  <div className="text-xs text-blue-600 mt-1">
                                    üìé {mouvement.uploadedFiles.length} fichier(s)
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })
                  ) : (
                    <div className="text-center py-8 text-gray-500">
                      <div className="text-4xl mb-4">üì≠</div>
                      <p>Aucun mouvement trouv√© avec les crit√®res s√©lectionn√©s</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Composant principal App
        function App() {
          const [currentUser, setCurrentUser] = useState(null);
          const [activeTab, setActiveTab] = useState('stock');
          const [articles, setArticles] = useState([]);
          const [users, setUsers] = useState([]);
          const [commandes, setCommandes] = useState([]);
          const [chantiers, setChantiers] = useState([]);
          const [historique, setHistorique] = useState([]);

          useEffect(() => {
            // Charger les donn√©es depuis Supabase
            const loadData = async () => {
              try {
                console.log('üîÑ Chargement des donn√©es depuis Supabase...');
                
                const [articlesData, usersData, commandesData, chantiersData, historiqueData] = await Promise.all([
                  window.supabaseDB.getArticles(),
                  window.supabaseDB.getUsers(),
                  window.supabaseDB.getCommandes(),
                  window.supabaseDB.getChantiers(),
                  window.supabaseDB.getHistorique()
                ]);
                
                setArticles(articlesData.length > 0 ? articlesData : initialArticles);
                setUsers(usersData.length > 0 ? usersData : initialUsers);
                setCommandes(commandesData || []);
                setChantiers(chantiersData.length > 0 ? chantiersData : initialChantiers);
                setHistorique(historiqueData || []);
                
                console.log('‚úÖ Donn√©es charg√©es avec succ√®s depuis Supabase');
                
                // D√©marrer la synchronisation temps r√©el
                window.supabaseDB.syncWithSupabase();
                
              } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                // Fallback vers localStorage si Supabase √©choue
                const savedArticles = localStorage.getItem('articles');
                const savedUsers = localStorage.getItem('users');
                const savedCommandes = localStorage.getItem('commandes');
                const savedChantiers = localStorage.getItem('chantiers');
                const savedHistorique = localStorage.getItem('historique');

                setArticles(savedArticles ? JSON.parse(savedArticles) : initialArticles);
                setUsers(savedUsers ? JSON.parse(savedUsers) : initialUsers);
                setCommandes(savedCommandes ? JSON.parse(savedCommandes) : []);
                setChantiers(savedChantiers ? JSON.parse(savedChantiers) : initialChantiers);
                setHistorique(savedHistorique ? JSON.parse(savedHistorique) : initialHistorique);
              }
            };
            
            loadData();
          }, []);

          // √âcouter les √©v√©nements de synchronisation temps r√©el
          useEffect(() => {
            const handleStockUpdate = (event) => {
              console.log('üîÑ Mise √† jour du stock re√ßue:', event.detail);
              // Recharger les articles si n√©cessaire
              window.supabaseDB.getArticles().then(data => {
                if (data.length > 0) setArticles(data);
              });
            };

            const handleMovementUpdate = (event) => {
              console.log('üîÑ Mise √† jour des mouvements re√ßue:', event.detail);
              // Recharger l'historique si n√©cessaire
              window.supabaseDB.getHistorique().then(data => {
                if (data.length > 0) setHistorique(data);
              });
            };

            const handleCommandeUpdate = (event) => {
              console.log('üîÑ Mise √† jour des commandes re√ßue:', event.detail);
              // Recharger les commandes si n√©cessaire
              window.supabaseDB.getCommandes().then(data => {
                if (data.length > 0) setCommandes(data);
              });
            };

            window.addEventListener('stock-updated', handleStockUpdate);
            window.addEventListener('movement-updated', handleMovementUpdate);
            window.addEventListener('commande-updated', handleCommandeUpdate);

            return () => {
              window.removeEventListener('stock-updated', handleStockUpdate);
              window.removeEventListener('movement-updated', handleMovementUpdate);
              window.removeEventListener('commande-updated', handleCommandeUpdate);
            };
          }, []);

                     const handleLogin = async (matricule, password) => {
             try {
               console.log('üîê Tentative de connexion pour matricule:', matricule);
               
               // R√©cup√©rer l'utilisateur depuis Supabase
               const { data: user, error } = await window.supabaseDB.getUserByMatricule(matricule);
               
               if (error) {
                 console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur:', error);
                 alert('Erreur de connexion. Veuillez r√©essayer.');
                 return;
               }
               
               console.log('üìã Donn√©es utilisateur r√©cup√©r√©es:', user);
               
               if (user && user.length > 0) {
                 const userData = user[0];
                 console.log('üë§ Donn√©es utilisateur:', userData);
                 console.log('üîë Mot de passe fourni:', password);
                 console.log('üîë Mot de passe en base:', userData.password);
                 
                 // V√©rifier le mot de passe
                 if (password === userData.password) {
                   // Formater l'utilisateur pour l'interface
                   const formattedUser = {
                     matricule: userData.matricule.toString(),
                     nom: userData.nom,
                     role: userData.role,
                     chantier: userData.chantier_id ? `Chantier ${String.fromCharCode(64 + userData.chantier_id)}` : 'Admin'
                   };
                   
                   setCurrentUser(formattedUser);
                   setActiveTab('stock');
                   console.log('‚úÖ Connexion r√©ussie:', formattedUser);
                 } else {
                   console.log('‚ùå Mot de passe incorrect');
                   alert('Mot de passe incorrect.');
                 }
               } else {
                 console.log('‚ùå Utilisateur non trouv√©');
                 alert('Matricule non trouv√©. Utilisez 100, 200, 300, 400, 500 ou 600.');
               }
             } catch (error) {
               console.error('Erreur lors de la connexion:', error);
               alert('Erreur de connexion. Veuillez r√©essayer.');
             }
           };

          const handleLogout = () => {
            setCurrentUser(null);
            setActiveTab('stock');
          };

          const updateArticle = async (id, updates) => {
            try {
              const { data, error } = await window.supabaseDB.updateArticle(id, updates);
              if (error) {
                console.error('Erreur mise √† jour article:', error);
                alert('Erreur lors de la mise √† jour de l\'article');
                return;
              }
              
              // Mettre √† jour l'√©tat local
              setArticles(articles.map(article => 
                article.id === id ? { ...article, ...updates } : article
              ));
              
              console.log('‚úÖ Article mis √† jour avec succ√®s');
            } catch (error) {
              console.error('Erreur mise √† jour article:', error);
              alert('Erreur lors de la mise √† jour de l\'article');
            }
          };

                               const addCommande = async (articleId, quantite, note = '') => {
            try {
              const article = articles.find(a => a.id === articleId);
              const newCommande = {
                article_id: articleId,
                quantite: parseInt(quantite),
                user_matricule: currentUser.matricule,
                chantier_id: article.chantier_id,
                notes: note,
                created_at: new Date().toISOString()
              };
              
              const { data, error } = await window.supabaseDB.addCommande(newCommande);
              if (error) {
                console.error('Erreur ajout commande:', error);
                alert('Erreur lors de l\'ajout de la commande');
                return;
              }
              
              // Ajouter √† l'√©tat local avec les donn√©es format√©es
              const localCommande = {
                id: data.id,
                articleId,
                articleNom: article.nom,
                quantite: parseInt(quantite),
                userName: currentUser.nom,
                userMatricule: currentUser.matricule,
                chantierId: article.chantier_id,
                date: new Date().toLocaleString('fr-FR'),
                note: note
              };
              
              setCommandes([...commandes, localCommande]);
              console.log('‚úÖ Commande ajout√©e avec succ√®s');
            } catch (error) {
              console.error('Erreur ajout commande:', error);
              alert('Erreur lors de l\'ajout de la commande');
            }
          };

           // Fonctions de gestion admin
           const updateUser = (matricule, updates) => {
             setUsers(users.map(user => 
               user.matricule === matricule ? { ...user, ...updates } : user
             ));
           };

           const deleteUser = (matricule) => {
             setUsers(users.filter(user => user.matricule !== matricule));
           };

           const addArticle = (newArticle) => {
             const article = {
               id: Date.now(),
               nom: newArticle.nom,
               icone: newArticle.icone,
               quantite: newArticle.quantite,
               entree: 0,
               sortie: 0,
               chantierId: newArticle.chantierId || 1 // Par d√©faut chantier 1
             };
             setArticles([...articles, article]);
           };

           const deleteArticle = (articleId) => {
             setArticles(articles.filter(article => article.id !== articleId));
           };

           // Fonctions de gestion des chantiers
           const addChantier = (newChantier) => {
             const chantier = {
               id: Date.now(),
               nom: newChantier.nom,
               description: newChantier.description,
               statut: newChantier.statut,
               pointeurs: []
             };
             setChantiers([...chantiers, chantier]);
           };

           const updateChantier = (chantierId, updates) => {
             setChantiers(chantiers.map(chantier => 
               chantier.id === chantierId ? { ...chantier, ...updates } : chantier
             ));
           };

           const deleteChantier = (chantierId) => {
             setChantiers(chantiers.filter(chantier => chantier.id !== chantierId));
           };

          if (!currentUser) {
            return <Login onLogin={handleLogin} users={users} />;
          }

                     return (
             <div className="min-h-screen bg-cover bg-center bg-no-repeat relative" style={{backgroundImage: 'url("./background.jpg.jpg")'}}>
               {/* Overlay sombre pour am√©liorer la lisibilit√© */}
               <div className="absolute inset-0 bg-black/30"></div>
               
               <header className="bg-white/95 backdrop-blur-sm shadow-sm border-b relative z-10">
                <div className="container mx-auto px-4 py-4">
                                     <div className="flex justify-between items-center">
                     <div className="flex items-center space-x-4">
                       <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                         <img src="./logo.jpg.jpg" alt="Logo" className="w-10 h-10 object-contain rounded-full" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                         <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm" style={{display: 'none'}}>NEK</div>
                       </div>
                       <h1 className="text-2xl font-bold text-gray-800">NAIT EL KHALFAOUI TRAVAUX</h1>
                     </div>
                    <div className="text-right">
                      <p className="font-medium text-gray-800">{currentUser.nom}</p>
                      <p className="text-sm text-gray-600">
                        {currentUser.role === 'admin' ? 'Administrateur' : `Pointeur - ${currentUser.chantier}`}
                      </p>
                      <button onClick={handleLogout} className="mt-2 text-sm text-red-600 hover:text-red-800">
                        Se d√©connecter
                      </button>
                    </div>
                  </div>
                </div>
              </header>

                             <nav className="bg-white/95 backdrop-blur-sm shadow-sm border-b relative z-10">
                 <div className="container mx-auto px-4">
                   <div className="flex space-x-8">
                     <button
                       onClick={() => setActiveTab('stock')}
                       className={`py-4 px-2 border-b-2 font-medium text-sm ${
                         activeTab === 'stock' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                       }`}
                     >
                       Stock
                     </button>
                     {currentUser.role === 'admin' && (
                       <button
                         onClick={() => setActiveTab('commandes')}
                         className={`py-4 px-2 border-b-2 font-medium text-sm ${
                           activeTab === 'commandes' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                         }`}
                       >
                         Commandes
                       </button>
                     )}
                     {currentUser.role === 'admin' && (
                       <button
                         onClick={() => setActiveTab('historique')}
                         className={`py-4 px-2 border-b-2 font-medium text-sm ${
                           activeTab === 'historique' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                         }`}
                       >
                         Historique
                       </button>
                     )}
                     {currentUser.role === 'admin' && (
                       <button
                         onClick={() => setActiveTab('admin')}
                         className={`py-4 px-2 border-b-2 font-medium text-sm ${
                           activeTab === 'admin' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                         }`}
                       >
                         Administration
                       </button>
                     )}
                   </div>
                 </div>
               </nav>

               <main className="container mx-auto p-4 relative z-10">
                                 {activeTab === 'stock' && (
                   <Stock 
                     articles={articles}
                     onUpdateArticle={updateArticle}
                     onAddCommande={addCommande}
                     currentUser={currentUser}
                     isAdmin={currentUser.role === 'admin'}
                     chantiers={chantiers}
                   />
                 )}
                 {activeTab === 'commandes' && currentUser.role === 'admin' && (
                   <Commands 
                     commandes={commandes} 
                     articles={articles} 
                     currentUser={currentUser}
                     isAdmin={currentUser.role === 'admin'}
                     chantiers={chantiers}
                   />
                 )}
                                 {activeTab === 'historique' && currentUser.role === 'admin' && (
                   <Historique 
                     historique={historique}
                     articles={articles}
                     users={users}
                     chantiers={chantiers}
                   />
                 )}
                                 {activeTab === 'admin' && currentUser.role === 'admin' && (
                   <Admin 
                     users={users} 
                     articles={articles}
                     chantiers={chantiers}
                     onUpdateUser={updateUser}
                     onDeleteUser={deleteUser}
                     onAddArticle={addArticle}
                     onDeleteArticle={deleteArticle}
                     onAddChantier={addChantier}
                     onUpdateChantier={updateChantier}
                     onDeleteChantier={deleteChantier}
                   />
                 )}
              </main>
            </div>
          );
        }

        // Rendu de l'application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-prompt').style.display = 'block';
        });
        
        document.getElementById('install-btn').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('pwa-install-prompt').style.display = 'none';
                });
            }
        });
        
        document.getElementById('dismiss-btn').addEventListener('click', () => {
            document.getElementById('pwa-install-prompt').style.display = 'none';
        });
    </script>
</body>
</html>
